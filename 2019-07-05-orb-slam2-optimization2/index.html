<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title> ğŸ˜€ ORB-SLAM2 ä»£ç è§£è¯»ï¼ˆä¸‰ï¼‰ï¼šä¼˜åŒ– 2ï¼ˆè¯¦è§£ &#43; g2o ä½¿ç”¨ï¼‰ - å´è¨€å´è¯­</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="wuxiaolang" /><meta name="description" content="0. åŸºæœ¬ä½¿ç”¨ 0.1 æ„é€  g2o æ¨¡å‹ é¦–å…ˆæ„é€  g2o æ¨¡å‹ï¼ŒåŒ…æ‹¬é€‰æ‹©çº¿æ€§æ–¹ç¨‹æ±‚è§£å™¨ã€çŸ©é˜µæ±‚è§£å™¨å’Œä¸‹é™ç®—æ³•ï¼› 1 2 3 4 5 6 7 8 9 10 11 12 13 // è®¾ç½®å›¾æ¨¡å‹åˆ›å»ºä¼˜åŒ–å™¨. g2o::SparseOptimizer optimizer; //" /><meta name="keywords" content="Hugo, theme, even" />


<meta name="baidu-site-verification" content="fHOS0ah0i1" />
<meta name="google-site-verification" content="4aEA7KB3m7LrWKNH4axTcMxXigooU2CLbEs_pmc_09s" />


<meta name="generator" content="Hugo 0.68.0 with theme even" />


<link rel="canonical" href="https://wym.netlify.com/2019-07-05-orb-slam2-optimization2/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.fdd8141c.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content=" ğŸ˜€ ORB-SLAM2 ä»£ç è§£è¯»ï¼ˆä¸‰ï¼‰ï¼šä¼˜åŒ– 2ï¼ˆè¯¦è§£ &#43; g2o ä½¿ç”¨ï¼‰" />
<meta property="og:description" content="0. åŸºæœ¬ä½¿ç”¨ 0.1 æ„é€  g2o æ¨¡å‹ é¦–å…ˆæ„é€  g2o æ¨¡å‹ï¼ŒåŒ…æ‹¬é€‰æ‹©çº¿æ€§æ–¹ç¨‹æ±‚è§£å™¨ã€çŸ©é˜µæ±‚è§£å™¨å’Œä¸‹é™ç®—æ³•ï¼› 1 2 3 4 5 6 7 8 9 10 11 12 13 // è®¾ç½®å›¾æ¨¡å‹åˆ›å»ºä¼˜åŒ–å™¨. g2o::SparseOptimizer optimizer; //" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wym.netlify.com/2019-07-05-orb-slam2-optimization2/" />
<meta property="article:published_time" content="2019-07-05T00:00:00+08:00" />
<meta property="article:modified_time" content="2019-07-05T00:00:00+08:00" />
<meta itemprop="name" content=" ğŸ˜€ ORB-SLAM2 ä»£ç è§£è¯»ï¼ˆä¸‰ï¼‰ï¼šä¼˜åŒ– 2ï¼ˆè¯¦è§£ &#43; g2o ä½¿ç”¨ï¼‰">
<meta itemprop="description" content="0. åŸºæœ¬ä½¿ç”¨ 0.1 æ„é€  g2o æ¨¡å‹ é¦–å…ˆæ„é€  g2o æ¨¡å‹ï¼ŒåŒ…æ‹¬é€‰æ‹©çº¿æ€§æ–¹ç¨‹æ±‚è§£å™¨ã€çŸ©é˜µæ±‚è§£å™¨å’Œä¸‹é™ç®—æ³•ï¼› 1 2 3 4 5 6 7 8 9 10 11 12 13 // è®¾ç½®å›¾æ¨¡å‹åˆ›å»ºä¼˜åŒ–å™¨. g2o::SparseOptimizer optimizer; //">
<meta itemprop="datePublished" content="2019-07-05T00:00:00&#43;08:00" />
<meta itemprop="dateModified" content="2019-07-05T00:00:00&#43;08:00" />
<meta itemprop="wordCount" content="12922">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=" ğŸ˜€ ORB-SLAM2 ä»£ç è§£è¯»ï¼ˆä¸‰ï¼‰ï¼šä¼˜åŒ– 2ï¼ˆè¯¦è§£ &#43; g2o ä½¿ç”¨ï¼‰"/>
<meta name="twitter:description" content="0. åŸºæœ¬ä½¿ç”¨ 0.1 æ„é€  g2o æ¨¡å‹ é¦–å…ˆæ„é€  g2o æ¨¡å‹ï¼ŒåŒ…æ‹¬é€‰æ‹©çº¿æ€§æ–¹ç¨‹æ±‚è§£å™¨ã€çŸ©é˜µæ±‚è§£å™¨å’Œä¸‹é™ç®—æ³•ï¼› 1 2 3 4 5 6 7 8 9 10 11 12 13 // è®¾ç½®å›¾æ¨¡å‹åˆ›å»ºä¼˜åŒ–å™¨. g2o::SparseOptimizer optimizer; //"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">å°å´åŒå­¦çš„å´è¨€å´è¯­</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">åšå®¢</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">åˆ†ç±»</li>
      </a><a href="/slam/">
        <li class="mobile-menu-item">SLAM</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a><a href="/za/">
        <li class="mobile-menu-item"></li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">å°å´åŒå­¦çš„å´è¨€å´è¯­</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">åšå®¢</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">åˆ†ç±»</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/slam/">SLAM</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/za/"></a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title"> ğŸ˜€ ORB-SLAM2 ä»£ç è§£è¯»ï¼ˆä¸‰ï¼‰ï¼šä¼˜åŒ– 2ï¼ˆè¯¦è§£ &#43; g2o ä½¿ç”¨ï¼‰</h1>

      <div class="post-meta">
        <span class="post-time"> 2019-07-05 </span>
        <div class="post-category">
            <a href="/categories/orb-slam2/"> ORB-SLAM2 </a>
            <a href="/categories/slam/"> SLAM </a>
            <a href="/categories/code/"> code </a>
            </div>
          <span class="more-meta"> çº¦ 12922 å­— </span>
          <span class="more-meta"> é¢„è®¡é˜…è¯» 26 åˆ†é’Ÿ </span>
        
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">æ–‡ç« ç›®å½•</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#0-åŸºæœ¬ä½¿ç”¨">0. åŸºæœ¬ä½¿ç”¨</a>
      <ul>
        <li><a href="#01-æ„é€ -g2o-æ¨¡å‹">0.1 æ„é€  g2o æ¨¡å‹</a></li>
        <li><a href="#02-g2o-ç±»å›¾">0.2 g2o ç±»å›¾</a></li>
      </ul>
    </li>
    <li><a href="#1-g2o-çš„é¡¶ç‚¹vertex">1. g2o çš„é¡¶ç‚¹ï¼ˆVertexï¼‰</a>
      <ul>
        <li><a href="#11-é¡¶ç‚¹çš„æ ¼å¼">1.1 é¡¶ç‚¹çš„æ ¼å¼</a></li>
        <li><a href="#12-è‡ªå®šä¹‰é¡¶ç‚¹">1.2 è‡ªå®šä¹‰é¡¶ç‚¹</a></li>
        <li><a href="#13-å°†é¡¶ç‚¹æ·»åŠ åˆ°å›¾ä¸­">1.3 å°†é¡¶ç‚¹æ·»åŠ åˆ°å›¾ä¸­</a></li>
      </ul>
    </li>
    <li><a href="#2-g2o-ä¸­çš„è¾¹">2. g2o ä¸­çš„è¾¹</a>
      <ul>
        <li><a href="#21-è¾¹çš„æ ¼å¼">2.1 è¾¹çš„æ ¼å¼</a></li>
        <li><a href="#22-è‡ªå®šä¹‰è¾¹">2.2 è‡ªå®šä¹‰è¾¹</a></li>
        <li><a href="#23-å°†è¾¹æ·»åŠ åˆ°å›¾ä¸­">2.3 å°†è¾¹æ·»åŠ åˆ°å›¾ä¸­</a></li>
      </ul>
    </li>
    <li><a href="#3-orb-slam2-ä¸­çš„é¡¶ç‚¹">3. ORB-SLAM2 ä¸­çš„é¡¶ç‚¹</a>
      <ul>
        <li><a href="#31-ç›¸æœºä½å§¿é¡¶ç‚¹">3.1 ç›¸æœºä½å§¿é¡¶ç‚¹</a></li>
        <li><a href="#32-åœ°å›¾ç‚¹åæ ‡é¡¶ç‚¹">3.2 åœ°å›¾ç‚¹åæ ‡é¡¶ç‚¹</a></li>
        <li><a href="#33-é—­ç¯æ—¶çš„-sim3-ç›¸æœºä½å§¿">3.3 é—­ç¯æ—¶çš„ sim3 ç›¸æœºä½å§¿</a></li>
      </ul>
    </li>
    <li><a href="#4-orb-slam2-ä¸­çš„è¾¹">4. ORB-SLAM2 ä¸­çš„è¾¹</a>
      <ul>
        <li><a href="#41-ä½å§¿ä¼˜åŒ–æ—¶çš„é‡æŠ•å½±è¯¯å·®">4.1 ä½å§¿ä¼˜åŒ–æ—¶çš„é‡æŠ•å½±è¯¯å·®</a></li>
        <li><a href="#42-ba-ä¼˜åŒ–æ—¶çš„é‡æŠ•å½±è¯¯å·®">4.2 BA ä¼˜åŒ–æ—¶çš„é‡æŠ•å½±è¯¯å·®</a></li>
        <li><a href="#43-é—­ç¯æ£€æµ‹æ—¶çš„é‡æŠ•å½±è¯¯å·®">4.3 é—­ç¯æ£€æµ‹æ—¶çš„é‡æŠ•å½±è¯¯å·®</a></li>
        <li><a href="#44-sim3-ä¹‹é—´çš„ç›¸å¯¹è¯¯å·®">4.4 Sim3 ä¹‹é—´çš„ç›¸å¯¹è¯¯å·®</a></li>
      </ul>
    </li>
    <li><a href="#5-orb-slam2-ä¸­çš„ä¼˜åŒ–å‡½æ•°">5. ORB-SLAM2 ä¸­çš„ä¼˜åŒ–å‡½æ•°</a>
      <ul>
        <li><a href="#51-ä½å§¿ä¼˜åŒ–å‡½æ•°-poseoptimization">5.1 ä½å§¿ä¼˜åŒ–å‡½æ•° PoseOptimization()</a></li>
        <li><a href="#52-å±€éƒ¨ä¼˜åŒ–-localbundleadjustment">5.2 å±€éƒ¨ä¼˜åŒ– LocalBundleAdjustment()</a></li>
        <li><a href="#53-å…¨å±€ä¼˜åŒ–-globalbundleadjustemnt">5.3 å…¨å±€ä¼˜åŒ– GlobalBundleAdjustemnt()</a></li>
        <li><a href="#54-é—­ç¯å¤„çš„-sim3-ä¼˜åŒ–-optimizesim3">5.4 é—­ç¯å¤„çš„ Sim3 ä¼˜åŒ– OptimizeSim3()</a></li>
        <li><a href="#55-é—­ç¯åçš„-sim3-ä½å§¿ä¼˜åŒ–-optimizeessentialgraph">5.5 é—­ç¯åçš„ Sim3 ä½å§¿ä¼˜åŒ– OptimizeEssentialGraph()</a></li>
      </ul>
    </li>
    <li><a href="#r-å‚è€ƒèµ„æ–™">R. å‚è€ƒèµ„æ–™</a></li>
    <li><a href="#todo">TODO</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="0-åŸºæœ¬ä½¿ç”¨">0. åŸºæœ¬ä½¿ç”¨</h2>
<h3 id="01-æ„é€ -g2o-æ¨¡å‹">0.1 æ„é€  g2o æ¨¡å‹</h3>
<ul>
<li>é¦–å…ˆæ„é€  g2o æ¨¡å‹ï¼ŒåŒ…æ‹¬é€‰æ‹©<strong>çº¿æ€§æ–¹ç¨‹æ±‚è§£å™¨ã€çŸ©é˜µæ±‚è§£å™¨å’Œä¸‹é™ç®—æ³•</strong>ï¼›
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// è®¾ç½®å›¾æ¨¡å‹åˆ›å»ºä¼˜åŒ–å™¨.
</span><span class="c1"></span><span class="n">g2o</span><span class="o">::</span><span class="n">SparseOptimizer</span> <span class="n">optimizer</span><span class="p">;</span>
<span class="c1">// ä½¿ç”¨Cholmodä¸­çš„çº¿æ€§æ–¹ç¨‹æ±‚è§£å™¨å¾—åˆ° linearSolver
</span><span class="c1"></span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_6_3</span><span class="o">::</span><span class="n">LinearSolverType</span> <span class="o">*</span> <span class="n">linearSolver</span><span class="p">;</span>
<span class="n">linearSolver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">LinearSolverDense</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_6_3</span><span class="o">::</span><span class="n">PoseMatrixType</span><span class="o">&gt;</span><span class="p">();</span>
<span class="c1">// å†ç”¨ç¨€ç–çŸ©é˜µå—æ±‚è§£å™¨ solver_ptr
</span><span class="c1"></span><span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_6_3</span> <span class="o">*</span> <span class="n">solver_ptr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver_6_3</span><span class="p">(</span><span class="n">linearSolver</span><span class="p">);</span>
<span class="c1">// é€‰æ‹©æ¢¯åº¦ä¸‹é™æ–¹æ³•ï¼šL-M ç®—æ³• æ±‚è§£ä¸Šé¢çš„ solver_ptr å¾—åˆ° solver.
</span><span class="c1"></span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmLevenberg</span><span class="o">*</span> <span class="n">solver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmLevenberg</span><span class="p">(</span><span class="n">solver_ptr</span><span class="p">);</span>
<span class="c1">// è®¾ç½®æ±‚è§£å™¨.
</span><span class="c1"></span><span class="n">optimizer</span><span class="p">.</span><span class="n">setAlgorithm</span><span class="p">(</span><span class="n">solver</span><span class="p">);</span>
<span class="c1">// æ‰“å¼€è°ƒè¯•è¾“å‡º
</span><span class="c1"></span><span class="n">optimizer</span><span class="p">.</span><span class="n">setVerbose</span><span class="p">(</span> <span class="nb">true</span> <span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="02-g2o-ç±»å›¾">0.2 g2o ç±»å›¾</h3>
<ul>
<li>
<p>å…ˆç»™å‡ºå‰é¢åˆå§‹åŒ–çš„ä»£ç å†çœ‹ç±»å›¾å§ï¼Œç›´æ¥çœ‹å›¾ä¸€è„¸æ‡µï¼Œå‚è€ƒ<a href="https://www.cnblogs.com/gaoxiang12/p/5304272.html">é«˜ç¿”çš„åšå®¢</a>
<img src="https://img-blog.csdnimg.cn/20181225224642745.png" alt=""></p>
</li>
<li>
<p>ä¸Šå›¾ä¸­å·¦ä¾§çš„ <strong><code>SparseOptimizer</code></strong> æ˜¯ç¬¬ä¸€æ­¥åˆå§‹åŒ–çš„å›¾æ¨¡å‹ï¼Œä¹Ÿæ˜¯æœ€ç»ˆè¦ç»´æŠ¤çš„ï¼›</p>
</li>
<li>
<p>å…ˆçœ‹<strong>ä¸‹åŠéƒ¨åˆ†</strong>ï¼Œå¯¹åº”å‰é¢çš„åˆå§‹åŒ–ä»£ç ï¼Œç”¨äº<strong>æŒ‡å®šæ±‚è§£å™¨å’Œè¿­ä»£ç®—æ³•</strong>ï¼Œä¸€ä¸ª <strong><code>SparseOptimizer</code></strong> æ‹¥æœ‰ä¸€ä¸ª <strong><code>Optimization Algorithm</code></strong> ï¼Œå…¶ä¼˜åŒ–ç®—æ³•ç»§æ‰¿è‡ª <strong><code>Gauss-Newton, Levernberg-Marquardt, Powell's dogleg</code></strong> ä¸‰è€…ä¹‹ä¸€ï¼Œä¸åŒçš„æ–¹æ³•è¡¨ç°ä¸ºæœ€ç»ˆçš„ H çŸ©é˜µæ„é€ ä¸åŒï¼›åŒæ—¶è¿™ä¸ª <code>Optimization Algorithm</code> æ‹¥æœ‰ä¸€ä¸ª <strong><code>Solver</code></strong> ï¼Œå…¶åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>ä¸€ä¸ªæ˜¯ <strong><code>SparseBlockMatrix</code></strong> ï¼Œç”¨äº<strong>è®¡ç®—ç¨€ç–çš„é›…å…‹æ¯”å’Œæµ·æ£®çŸ©é˜µ</strong>ï¼›</li>
<li>å¦ä¸€ä¸ªæ˜¯æ„é€ <strong>çº¿æ€§æ–¹ç¨‹æ±‚è§£å™¨</strong>ï¼Œå¯ä»¥ä» PCG, CSparse, Choldmod ä¸‰è€…é€‰åˆ™ï¼Œç”¨äºè®¡ç®—è¿­ä»£è¿‡ç¨‹ä¸­æœ€å…³é”®çš„ä¸€æ­¥
$$
H \Delta x = -b
$$</li>
</ul>
</li>
<li>
<p>ç„¶åçœ‹<strong>ä¸ŠåŠéƒ¨åˆ†</strong> <strong><code>SparseOptimizer</code></strong> æ˜¯ä¸€ä¸ª <strong><code>Optimizable Graph</code></strong> ï¼Œä»è€Œä¹Ÿæ˜¯ä¸€ä¸ª <strong><code>Hyper Graph</code></strong>ï¼ˆè¶…å›¾ï¼‰ï¼Œ ä¸€ä¸ª <code>SparseOptimizer</code> å«æœ‰å¾ˆå¤šä¸ª<strong>é¡¶ç‚¹</strong>å’Œå¾ˆå¤šä¸ª<strong>è¾¹</strong>ï¼›</p>
<ul>
<li>é¡¶ç‚¹ç»§æ‰¿è‡ª <code>Base Vertex</code>ï¼Œä¹Ÿå°±æ˜¯ <code>OptimizableGraph::Vertex</code>ï¼›</li>
<li>è¾¹ç»§æ‰¿è‡ª <code>OptimizableGraph::Edge</code>ï¼Œåˆåˆ†ä¸º <code>BaseUnaryEdge</code>ï¼ˆå•è¾¹ï¼‰, <code>BaseBinaryEdge</code>ï¼ˆåŒè¾¹ï¼‰æˆ– <code>BaseMultiEdge</code>ï¼ˆå¤šè¾¹ï¼‰ï¼›</li>
<li>è¿™äº› <code>Base Vertex</code> å’Œ <code>Base Edge</code> éƒ½æ˜¯æŠ½è±¡çš„åŸºç±»ï¼Œè€Œ<strong>å®é™…ç”¨çš„é¡¶ç‚¹å’Œè¾¹ï¼Œéƒ½æ˜¯å®ƒä»¬çš„æ´¾ç”Ÿç±»</strong>ï¼›</li>
<li>ç”¨ <code>SparseOptimizer.addVertex()</code> å’Œ <code>SparseOptimizer.addEdge()</code> å‘ä¸€ä¸ªå›¾ä¸­<strong>æ·»åŠ é¡¶ç‚¹å’Œè¾¹</strong>ï¼Œæœ€åè°ƒç”¨ <code>SparseOptimizer.optimize()</code> å®Œæˆä¼˜åŒ–ã€‚</li>
</ul>
</li>
<li>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œåœ¨ g2o ä¸­é€‰æ‹©ä¼˜åŒ–æ–¹æ³•ä¸€å…±æœ‰ä¸‰ä¸ªæ­¥éª¤</p>
<ul>
<li><strong>æ­¥éª¤ä¸€ï¼š</strong> é€‰æ‹©çº¿æ€§æ–¹ç¨‹ $H \Delta x = -b$ çš„<!-- raw HTML omitted --><strong>çº¿æ€§æ–¹ç¨‹æ±‚è§£å™¨</strong><!-- raw HTML omitted -->ï¼Œå®Œå…¨é‡‡ç”¨ç¬¬ä¸‰æ–¹çš„çº¿æ€§ä»£æ•°åº“ï¼Œä¸»è¦é‡‡ç”¨ Cholesky åˆ†è§£å’Œ PCG è¿­ä»£ï¼Œå…·ä½“å¯ä»¥é€‰æ‹©çš„æœ‰
<ul>
<li>Cholmodï¼ŒCSparse ï¼ˆä»¥ä¸Šä¸¤è€…ä¸ºæ¯”è¾ƒè‘—åçš„çº¿æ€§ä»£æ•°åº“ï¼‰ï¼Œ</li>
<li>PCG ï¼ˆpre-conditioner is block Jacobiï¼‰ï¼Œ</li>
<li>Denseï¼ˆdense Cholesky decompositionï¼‰ï¼Œ</li>
<li>æˆ–è€… ORB-SLAMä¸­ä½¿ç”¨çš„Eigenï¼ˆsparse Cholesky decoposition from Eigenï¼‰</li>
</ul>
</li>
<li><strong>æ­¥éª¤äºŒï¼š</strong> å—æ±‚è§£å™¨ BlockSolver æ„é€ çº¿æ€§æ–¹ç¨‹æ±‚è§£å™¨æ‰€éœ€è¦çš„<!-- raw HTML omitted -->**çŸ©é˜µå—ï¼ˆH å’Œ bï¼‰**<!-- raw HTML omitted -->ï¼Œéœ€è¦ç”¨åˆ°è¾¹çš„é›…å…‹æ¯”
$$
H = J^{T}WJ, \quad b=J^{T}W\delta 
$$
<ul>
<li>éœ€è¦<strong>æŒ‡å®šä¼˜åŒ–å˜é‡çš„ç»´åº¦</strong>ï¼Œå¸¸è§çš„æœ‰ä»¥ä¸‹å‡ ç§ï¼Œå…¶ä¸­ 6 è¡¨ç¤ºå¾…ä¼˜åŒ–å˜é‡çš„ç»´åº¦ï¼Œ 3 è¡¨ç¤ºè¯¯å·®é¡¹çš„ç»´åº¦ï¼Œå¯ä»¥è®¾ç½®ä¸º<strong>åŠ¨æ€çš„ BlockSolverX</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// variable size solver
</span><span class="c1"></span><span class="k">using</span> <span class="n">BlockSolverX</span> <span class="o">=</span> <span class="n">BlockSolverPL</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Dynamic</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Dynamic</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// solver for BA/3D SLAM
</span><span class="c1"></span><span class="k">using</span> <span class="n">BlockSolver_6_3</span> <span class="o">=</span> <span class="n">BlockSolverPL</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// solver fo BA with scale
</span><span class="c1"></span><span class="k">using</span> <span class="n">BlockSolver_7_3</span> <span class="o">=</span> <span class="n">BlockSolverPL</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">,</span> <span class="mi">3</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// 2Dof landmarks 3Dof poses
</span><span class="c1"></span><span class="k">using</span> <span class="n">BlockSolver_3_2</span> <span class="o">=</span> <span class="n">BlockSolverPL</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li><strong>æ­¥éª¤ä¸‰ï¼š</strong> é€‰æ‹©<!-- raw HTML omitted --><strong>ä¸‹é™è¿­ä»£ç­–ç•¥</strong><!-- raw HTML omitted -->ï¼Œä» GN, LM, Doglog ä¸­é€‰æ‹©ã€‚</li>
</ul>
</li>
<li>
<p>ç»“åˆå‰é¢ 0.1 èŠ‚ï¼Œæ€»ç»“ä¸€ä¸‹ <strong>g2o ä½¿ç”¨çš„æµç¨‹</strong></p>
<ul>
<li><!-- raw HTML omitted --><strong>æ­¥éª¤ä¸€ï¼š</strong> åˆ›å»ºçº¿æ€§æ–¹ç¨‹æ±‚è§£å™¨ï¼Œç¡®å®šåˆ†è§£æ–¹æ³•<!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// æ¯ä¸ªè¯¯å·®é¡¹ä¼˜åŒ–å˜é‡ç»´åº¦ä¸º3ï¼Œè¯¯å·®å€¼ç»´åº¦ä¸º1
</span><span class="c1"></span><span class="k">typedef</span> <span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolver</span><span class="o">&lt;</span> <span class="n">g2o</span><span class="o">::</span><span class="n">BlockSolverTraits</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">Block</span><span class="p">;</span>  
<span class="c1">// åˆ›å»ºä¸€ä¸ªçº¿æ€§æ±‚è§£å™¨ LinearSolverï¼Œé‡‡ç”¨ dense cholesky åˆ†è§£æ³•
</span><span class="c1"></span><span class="n">Block</span><span class="o">::</span><span class="n">LinearSolverType</span><span class="o">*</span> <span class="n">linearSolver</span> 
    <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">LinearSolverDense</span><span class="o">&lt;</span><span class="n">Block</span><span class="o">::</span><span class="n">PoseMatrixType</span><span class="o">&gt;</span><span class="p">();</span> 
</code></pre></td></tr></table>
</div>
</div><ul>
<li>è¦æ±‚è§£çš„å¢é‡æ–¹ç¨‹ä¸º $H \Delta x = -b$ï¼Œé€šå¸¸æƒ³åˆ°çš„æ–¹æ³•å°±æ˜¯ç›´æ¥æ±‚é€† $\Delta x = -H^{-1}*b$ï¼Œå¯¹äºè¾ƒå°ç»´åº¦çš„ H çŸ©é˜µå¯ä»¥ç›´æ¥æ±‚é€†ï¼Œä½†å½“ H ç»´åº¦è¾ƒå¤§æ—¶é‡‡ç”¨ä¸‹é¢çš„æ–¹æ³•è¿›è¡Œ<strong>æ±‚é€†</strong>ï¼š
<ul>
<li>LinearSolverCholmodï¼šä½¿ç”¨ sparse <strong>cholesky åˆ†è§£æ³•</strong>ï¼Œç»§æ‰¿è‡ªLinearSolverCCSï¼›</li>
<li>LinearSolverCSparseï¼šä½¿ç”¨ CSparse æ³•ï¼Œç»§æ‰¿è‡ªLinearSolverCCSï¼›</li>
<li>LinearSolverPCG ï¼šä½¿ç”¨preconditioned conjugate gradient æ³•ï¼Œç»§æ‰¿è‡ª LinearSolver</li>
<li>LinearSolverDense ï¼šä½¿ç”¨ dense <strong>cholesky åˆ†è§£æ³•</strong>ï¼Œç»§æ‰¿è‡ª LinearSolver</li>
<li>LinearSolverEigenï¼š ä¾èµ–é¡¹åªæœ‰ eigenï¼Œä½¿ç”¨ eigen ä¸­ sparse Cholesky  æ±‚è§£ï¼Œå› æ­¤ç¼–è¯‘å¥½åå¯ä»¥æ–¹ä¾¿çš„åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨ï¼Œæ€§èƒ½å’Œ CSparse å·®ä¸å¤šï¼Œç»§æ‰¿è‡ª LinearSolverï¼›</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li><!-- raw HTML omitted --><strong>æ­¥éª¤äºŒï¼š</strong> æ„é€ çº¿æ€§æ–¹ç¨‹çš„çŸ©é˜µå—ï¼Œå¹¶ç”¨ä¸Šé¢å®šä¹‰çš„çº¿æ€§æ±‚è§£å™¨åˆå§‹åŒ–<!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">Block</span><span class="o">*</span> <span class="n">solver_ptr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Block</span><span class="p">(</span> <span class="n">linearSolver</span> <span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>BlockSolver å†…éƒ¨åŒ…å« LinearSolverï¼Œç”¨ä¸Šé¢å®šä¹‰çš„çº¿æ€§æ±‚è§£å™¨ LinearSolver æ¥åˆå§‹åŒ–ï¼Œå‰é¢å·²ç»ç»™å®šäº†ä¼˜åŒ–å˜é‡çš„ç»´åº¦ï¼›</li>
</ul>
</li>
<li><!-- raw HTML omitted --><strong>æ­¥éª¤ä¸‰ï¼š</strong> åˆ›å»ºæ€»æ±‚è§£å™¨ solverï¼Œå¹¶ä» GN, LM, DogLeg ä¸­é€‰ä¸€ä¸ªï¼Œå†ç”¨ä¸Šè¿°å—æ±‚è§£å™¨ BlockSolver åˆå§‹åŒ–<!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmLevenberg</span><span class="o">*</span> <span class="n">solver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmLevenberg</span><span class="p">(</span> <span class="n">solver_ptr</span> <span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>ä¼˜åŒ–ç®—æ³•
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmGaussNewton</span>
<span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmLevenberg</span> 
<span class="n">g2o</span><span class="o">::</span><span class="n">OptimizationAlgorithmDogleg</span> 
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li><!-- raw HTML omitted --><strong>æ­¥éª¤å››ï¼š</strong> åˆ›å»ºç¨€ç–ä¼˜åŒ–å™¨ï¼ˆSparseOptimizerï¼‰<!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">g2o</span><span class="o">::</span><span class="n">SparseOptimizer</span> <span class="n">optimizer</span><span class="p">;</span>     <span class="c1">// å›¾æ¨¡å‹
</span><span class="c1"></span><span class="n">optimizer</span><span class="p">.</span><span class="n">setAlgorithm</span><span class="p">(</span> <span class="n">solver</span> <span class="p">);</span>   <span class="c1">// ç”¨å‰é¢å®šä¹‰å¥½çš„æ±‚è§£å™¨ä½œä¸ºæ±‚è§£æ–¹æ³•ï¼š
</span><span class="c1"></span><span class="n">optimizer</span><span class="p">.</span><span class="n">setVerbose</span><span class="p">(</span> <span class="nb">true</span> <span class="p">);</span>       <span class="c1">// æ‰“å¼€è°ƒè¯•è¾“å‡º
</span></code></pre></td></tr></table>
</div>
</div></li>
<li><!-- raw HTML omitted --><strong>æ­¥éª¤äº”ï¼š</strong> å®šä¹‰å›¾çš„é¡¶ç‚¹å’Œè¾¹ï¼Œå¹¶æ·»åŠ åˆ° SparseOptimizer ä¼˜åŒ–å™¨ä¸­<!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// åˆ›å»ºä¸€ä¸ªé¡¶ç‚¹
</span><span class="c1"></span><span class="n">CurveFittingVertex</span><span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CurveFittingVertex</span><span class="p">();</span> 
<span class="c1">// åˆå§‹åŒ–é¡¶ç‚¹çš„å€¼
</span><span class="c1"></span><span class="n">v</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">);</span>
<span class="c1">// è®¾ç½®é¡¶ç‚¹çš„ç¼–å·
</span><span class="c1"></span><span class="n">v</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="c1">// å‘å›¾ä¸­æ·»åŠ é¡¶ç‚¹
</span><span class="c1"></span><span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span><span class="p">(</span> <span class="n">v</span> <span class="p">);</span>
      
<span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>    <span class="c1">// å¾€å›¾ä¸­å¢åŠ è¾¹
</span><span class="c1"></span><span class="p">{</span>
    <span class="c1">// åˆ›å»ºä¸€æ¡è¾¹
</span><span class="c1"></span>    <span class="n">CurveFittingEdge</span><span class="o">*</span> <span class="n">edge</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CurveFittingEdge</span><span class="p">(</span> <span class="n">x_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span>
    <span class="c1">// è®¾ç½®è¾¹çš„ id
</span><span class="c1"></span>    <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="c1">// è®¾ç½®è¾¹è¿æ¥çš„é¡¶ç‚¹
</span><span class="c1"></span>    <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v</span> <span class="p">);</span>                
    <span class="c1">// è®¾ç½®è§‚æµ‹æ•°å€¼
</span><span class="c1"></span>    <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setMeasurement</span><span class="p">(</span> <span class="n">y_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span>      
    <span class="c1">// è®¾ç½®ä¿¡æ¯çŸ©é˜µï¼šåæ–¹å·®çŸ©é˜µä¹‹é€†
</span><span class="c1"></span>    <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setInformation</span><span class="p">(</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;::</span><span class="n">Identity</span><span class="p">()</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">w_sigma</span><span class="o">*</span><span class="n">w_sigma</span><span class="p">)</span> <span class="p">);</span> 
    <span class="c1">// å°†è¾¹æ·»åŠ åˆ°å›¾ä¸­
</span><span class="c1"></span>    <span class="n">optimizer</span><span class="p">.</span><span class="n">addEdge</span><span class="p">(</span> <span class="n">edge</span> <span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><!-- raw HTML omitted --><strong>æ­¥éª¤å…­ï¼š</strong> è®¾ç½®ä¼˜åŒ–å‚æ•°ï¼Œå¼€å§‹æ‰§è¡Œä¼˜åŒ–<!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">optimizer</span><span class="p">.</span><span class="n">initializeOptimization</span><span class="p">();</span>
<span class="n">optimizer</span><span class="p">.</span><span class="n">optimize</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span> <span class="c1">// è¿­ä»£æ¬¡æ•°
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<hr>
<h2 id="1-g2o-çš„é¡¶ç‚¹vertex">1. g2o çš„é¡¶ç‚¹ï¼ˆVertexï¼‰</h2>
<h3 id="11-é¡¶ç‚¹çš„æ ¼å¼">1.1 é¡¶ç‚¹çš„æ ¼å¼</h3>
<p>â€ƒâ€ƒå›åˆ°å‰é¢çš„ç±»å›¾ä¸Šé¢çš„<strong>é¡¶ç‚¹</strong>éƒ¨åˆ†çš„ç®­å¤´ï¼Œg2o æä¾›äº†ä¸€ä¸ªæ¯”è¾ƒé€šç”¨çš„é€‚åˆå¤§å¤šæ•°æƒ…å†µçš„<strong>æ¨¡æ¿ç±» BaseVertex&lt;D, T&gt;ï¼ˆå®šä¹‰åœ¨ g2o/core/base_vertex.h ä¸­ï¼‰</strong>ï¼Œå…¶ç»§æ‰¿è‡ª OptimizableGraph::Vertexï¼ˆå®šä¹‰åœ¨ g2o/core/optimizable_graph.h ä¸­ï¼‰ï¼ŒOptimizableGraph åˆç»§æ‰¿è‡ª HyperGraph::Vertexï¼ˆå®šä¹‰åœ¨ g2o/core/hyper_graph.h ä¸­ï¼‰ï¼Œåä¸¤è€…éƒ½æ¯”è¾ƒåº•å±‚ï¼Œä¸€èˆ¬ä½¿ç”¨ç¬¬ä¸€ä¸ªã€‚</p>
<ul>
<li>å†æ¥çœ‹çœ‹ <!-- raw HTML omitted --><strong>BaseVertex&lt;D, T&gt; ç±»çš„æ¨¡æ¿å‚æ•° Dï¼ŒT</strong><!-- raw HTML omitted -->
<ul>
<li><strong>D</strong> æ˜¯ int ç±»å‹ï¼Œè¡¨ç¤ºé¡¶ç‚¹ <strong>Vertex çš„æœ€å°ç»´åº¦</strong>ï¼Œæ¯”å¦‚ 3D ç©ºé—´ä¸­æ—‹è½¬æ˜¯ 3 ç»´çš„ï¼Œé‚£ä¹ˆè¿™é‡Œ D=3ï¼›
<ul>
<li>åœ¨æºç æ³¨é‡Šä¸­è¯´ D å¹¶éæ˜¯é¡¶ç‚¹ï¼ˆæ›´ç¡®åˆ‡çš„è¯´æ˜¯çŠ¶æ€å˜é‡ï¼‰çš„ç»´åº¦ï¼Œè€Œæ˜¯å…¶åœ¨<strong>æµå½¢ç©ºé—´ï¼ˆmanifoldï¼‰çš„æœ€å°è¡¨ç¤º</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">Dimension</span> <span class="o">=</span> <span class="n">D</span><span class="p">;</span> <span class="c1">///&lt; dimension of the estimate (minimal) in the manifold space
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li><strong>T</strong> æ˜¯å¾…ä¼°è®¡ <strong>Vertex çš„æ•°æ®ç±»å‹</strong>ï¼Œæ¯”å¦‚ç”¨å››å…ƒæ•°è¡¨è¾¾ä¸‰ç»´æ—‹è½¬çš„è¯ï¼ŒT å°±æ˜¯ Quaternion ç±»å‹
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">typedef</span> <span class="n">T</span> <span class="n">EstimateType</span><span class="p">;</span>
<span class="n">EstimateType</span> <span class="n">_estimate</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li>g2o æä¾›çš„<strong>å¸¸ç”¨çš„é¡¶ç‚¹ç±»å‹</strong>ï¼Œè‹¥æ²¡æœ‰çš„ç±»å‹å¯å‚è€ƒè‡ªå·±å®šä¹‰
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="nl">VertexSE2</span> <span class="p">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="n">SE2</span><span class="o">&gt;</span> <span class="c1">//2D pose Vertex, (x,y,theta)
</span><span class="c1"></span><span class="nl">VertexSE3</span> <span class="p">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">,</span> <span class="n">SE3Quat</span><span class="o">&gt;</span>
<span class="nl">VertexSE3</span> <span class="p">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">,</span> <span class="n">Isometry3</span><span class="o">&gt;</span>
<span class="nl">VertexPointXY</span> <span class="p">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector2d</span><span class="o">&gt;</span>
<span class="nl">VertexPointXYZ</span> <span class="p">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="n">Vector3</span><span class="o">&gt;</span>
<span class="nl">VertexLine2D</span> <span class="p">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="n">Line2D</span><span class="o">&gt;</span>
<span class="nl">VertexLine3D</span> <span class="p">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">,</span> <span class="n">Line3D</span><span class="o">&gt;</span>
<span class="nl">VertexSegment2D</span> <span class="p">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">,</span> <span class="n">Vector4</span><span class="o">&gt;</span>
<span class="nl">VertexCircle</span> <span class="p">:</span> <span class="k">public</span> <span class="n">g2o</span><span class="o">::</span><span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="o">&gt;</span>
<span class="nl">VertexPlane</span> <span class="p">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="n">Plane3D</span><span class="o">&gt;</span>
<span class="nl">VertexCam</span> <span class="p">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">,</span> <span class="n">SBACam</span><span class="o">&gt;</span>
<span class="nl">VertexPosition3D</span> <span class="p">:</span> <span class="k">public</span> <span class="n">g2o</span><span class="o">::</span><span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="o">&gt;</span>
<span class="nl">VertexPositionVelocity3D</span> <span class="p">:</span> <span class="k">public</span> <span class="n">g2o</span><span class="o">::</span><span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">,</span> <span class="n">Vector6d</span><span class="o">&gt;</span>
<span class="nl">VertexOdomDifferentialParams</span><span class="p">:</span> <span class="k">public</span> <span class="n">BaseVertex</span> <span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="n">Vector3</span><span class="o">&gt;</span>
<span class="nl">VertexCameraBAL</span> <span class="p">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">9</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="o">&gt;</span>
<span class="nl">VertexSim3Expmap</span> <span class="p">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">,</span> <span class="n">Sim3</span><span class="o">&gt;</span>
<span class="nl">VertexParams</span> <span class="p">:</span> <span class="k">public</span> <span class="n">g2o</span><span class="o">::</span><span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="o">&gt;</span>
<span class="nl">VertexSE3Expmap</span> <span class="p">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">,</span> <span class="n">SE3Quat</span><span class="o">&gt;</span>
<span class="nl">VertexBaseline</span> <span class="p">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="kt">double</span><span class="o">&gt;</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>é¡¶ç‚¹<strong>ä¸»è¦çš„æˆå‘˜å‡½æ•°</strong>ï¼ˆä½äº g2o/core/base_vertex.h ä¸­ï¼‰
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// è¿”å›ä¼˜åŒ–ä¹‹åé¡¶ç‚¹çš„å€¼.
</span><span class="c1"></span><span class="k">const</span> <span class="n">EstimateType</span><span class="o">&amp;</span> <span class="n">estimate</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">_estimate</span><span class="p">;}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="12-è‡ªå®šä¹‰é¡¶ç‚¹">1.2 è‡ªå®šä¹‰é¡¶ç‚¹</h3>
<ul>
<li>
<p>è‡ªå®šä¹‰ä¸€ä¸ªé¡¶ç‚¹éœ€è¦<!-- raw HTML omitted --><strong>é‡å†™ä»¥ä¸‹å‡½æ•°</strong><!-- raw HTML omitted --></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">);</span>
<span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
<span class="k">virtual</span> <span class="kt">void</span> <span class="nf">setToOriginImpl</span><span class="p">();</span>
<span class="k">virtual</span> <span class="kt">void</span> <span class="nf">oplusImpl</span><span class="p">(</span><span class="k">const</span> <span class="n">number_t</span><span class="o">*</span> <span class="n">update</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>read()</code> å’Œ <code>write()</code> è¯»ç›˜ã€å­˜ç›˜å‡½æ•°</strong>ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦è¿›è¡Œè¯»/å†™æ“ä½œçš„è¯ï¼Œä»…å£°æ˜ä¸€ä¸‹å°±å¯ä»¥äº†ï¼›</li>
<li><strong><code>setToOriginImpl()</code> æ˜¯é¡¶ç‚¹é‡ç½®å‡½æ•°</strong>ï¼Œè®¾ç½®è¢«ä¼˜åŒ–å˜é‡çš„<strong>åˆå§‹å€¼</strong>ï¼›</li>
<li><!-- raw HTML omitted --><strong><code>oplusImpl()</code> æ˜¯é¡¶ç‚¹æ›´æ–°å‡½æ•°</strong><!-- raw HTML omitted -->ï¼Œä¸»è¦ç”¨äºä¼˜åŒ–è¿‡ç¨‹ä¸­å¢é‡ $\Delta x$ çš„è®¡ç®—ï¼›</li>
</ul>
</li>
<li>
<p><!-- raw HTML omitted -->è‡ªå®šä¹‰é¡¶ç‚¹ç±»çš„<strong>æ ¼å¼</strong><!-- raw HTML omitted --></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">myVertex</span><span class="o">:</span> <span class="k">public</span> <span class="n">g2</span><span class="o">::</span><span class="n">BaseVertex</span><span class="o">&lt;</span><span class="n">Dim</span><span class="p">,</span> <span class="n">Type</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="c1">// ç±»æˆå‘˜å˜é‡å¦‚æœæ˜¯å›ºå®šå¤§å°å¯¹è±¡éœ€è¦åŠ ä¸Šä»¥ä¸‹çš„å®å®šä¹‰
</span><span class="c1"></span>  <span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>

  <span class="c1">// æ„é€ å‡½æ•°
</span><span class="c1"></span>  <span class="n">myVertex</span><span class="p">(){}</span>
      
  <span class="c1">// è¯»å†™å‡½æ•°
</span><span class="c1"></span>  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">)</span> <span class="p">{}</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span> <span class="k">const</span> <span class="p">{}</span>

  <span class="c1">// é‡ç½®å‡½æ•°
</span><span class="c1"></span>  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">setOriginImpl</span><span class="p">()</span>
  <span class="p">{</span>
      <span class="n">_estimate</span> <span class="o">=</span> <span class="n">Type</span><span class="p">();</span>
  <span class="p">}</span>
    
  <span class="c1">// æ›´æ–°å‡½æ•°
</span><span class="c1"></span>  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">oplusImpl</span><span class="p">(</span><span class="k">const</span> <span class="kt">double</span><span class="o">*</span> <span class="n">update</span><span class="p">)</span> <span class="k">override</span>
  <span class="p">{</span>
      <span class="n">_estimate</span> <span class="o">+=</span> <span class="cm">/*update*/</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>ä¸¾ä¾‹ä¸€ï¼š</strong> ä»¥ SLAM åå››è®²ä¸­æ›²çº¿æ‹Ÿåˆçš„<strong>æ›²çº¿æ¨¡å‹é¡¶ç‚¹</strong>ä¸ºä¾‹</p>
<ul>
<li>å®šä¹‰é¡¶ç‚¹ä¸º <code>CurveFittingVertex</code>ï¼Œé¡¶ç‚¹ç»´åº¦ä¸º 3ï¼Œç±»å‹ä¸º <code>Eigen::Vector3d</code>ï¼›</li>
<li>åˆå§‹å€¼è®¾ä¸ºä¸º <code>0, 0, 0</code>ï¼›</li>
<li>æ›´æ–°å‡½æ•°ä¸­ç”±äºæ˜¯<strong>å‘é‡ç›´æ¥åŠ ä¸Šæ›´æ–°é‡</strong> <code>_estimate += Eigen::Vector3d(update)</code>ï¼›</li>
<li>è¯»å†™å‡½æ•°ç•™ç©ºã€‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">CurveFittingVertex</span><span class="o">:</span> <span class="k">public</span> <span class="n">g2o</span><span class="o">::</span><span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>
      
    <span class="c1">// é‡ç½®
</span><span class="c1"></span>    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">setToOriginImpl</span><span class="p">()</span> 
    <span class="p">{</span>
        <span class="n">_estimate</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
      
    <span class="c1">// æ›´æ–°
</span><span class="c1"></span>    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">oplusImpl</span><span class="p">(</span> <span class="k">const</span> <span class="kt">double</span><span class="o">*</span> <span class="n">update</span> <span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">_estimate</span> <span class="o">+=</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="p">(</span><span class="n">update</span><span class="p">);</span>
    <span class="p">}</span>
      
    <span class="c1">// å­˜ç›˜å’Œè¯»ç›˜ï¼šç•™ç©º
</span><span class="c1"></span>    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">read</span><span class="p">(</span> <span class="n">istream</span><span class="o">&amp;</span> <span class="n">in</span> <span class="p">)</span> <span class="p">{}</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">write</span><span class="p">(</span> <span class="n">ostream</span><span class="o">&amp;</span> <span class="n">out</span> <span class="p">)</span> <span class="k">const</span> <span class="p">{}</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>ä¸¾ä¾‹äºŒï¼š</strong> ä»¥<strong>æä»£æ•°è¡¨ç¤ºçš„ä½å§¿ä½œä¸ºé¡¶ç‚¹</strong>ï¼Œä½äº <code>g2o/types/sba/types_six_dof_expmap.h</code> ä¸­</p>
<ul>
<li>å®šä¹‰é¡¶ç‚¹ç±»ä¸º <code>VertexSE3Expmap</code>ï¼Œä¼˜åŒ–å˜é‡æ˜¯ 6 è‡ªç”±åº¦çš„æä»£æ•°ï¼›</li>
<li><strong>æ›´æ–°å‡½æ•°é‡‡ç”¨æä»£æ•°çš„å¢é‡æ‰°åŠ¨æ›´æ–°</strong></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="cm">/**
</span><span class="cm"> * \brief SE3 Vertex parameterized internally with a transformation matrix
</span><span class="cm"> and externally with its exponential map
</span><span class="cm"> */</span>
<span class="k">class</span>  <span class="nc">VertexSE3Expmap</span> <span class="o">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">,</span> <span class="n">SE3Quat</span><span class="o">&gt;</span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>

  <span class="c1">// æ„é€ å‡½æ•°.
</span><span class="c1"></span>  <span class="n">VertexSE3Expmap</span><span class="p">();</span>

  <span class="c1">// 1. è¯»ç›˜.
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="nf">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">);</span>
  <span class="c1">// 2. å†™ç›˜.
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">// 3. é¡¶ç‚¹é‡ç½®å‡½æ•°ï¼Œè®¾å®šè¢«ä¼˜åŒ–å˜é‡çš„åŸå§‹å€¼
</span><span class="c1"></span>  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">setToOriginImpl</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">_estimate</span> <span class="o">=</span> <span class="n">SE3Quat</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// 4. é¡¶ç‚¹æ›´æ–°å‡½æ•°ï¼Œå¢é‡æ›´æ–°
</span><span class="c1"></span>  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">oplusImpl</span><span class="p">(</span><span class="k">const</span> <span class="kt">double</span><span class="o">*</span> <span class="n">update_</span><span class="p">)</span>  <span class="p">{</span>
    <span class="n">Eigen</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Vector6d</span><span class="o">&gt;</span> <span class="n">update</span><span class="p">(</span><span class="n">update_</span><span class="p">);</span>
    <span class="n">setEstimate</span><span class="p">(</span><span class="n">SE3Quat</span><span class="o">::</span><span class="n">exp</span><span class="p">(</span><span class="n">update</span><span class="p">)</span><span class="o">*</span><span class="n">estimate</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>ä¸¾ä¾‹ä¸‰ï¼š</strong> ä»¥ä¸‰ç»´å‘é‡è¡¨ç¤ºçš„<strong>ä¸‰ç»´ç‚¹</strong>ä½œä¸ºé¡¶ç‚¹ï¼Œä½äº <code>g2o/types/types_sba.h</code> ä¸­</p>
<ul>
<li>å®šä¹‰é¡¶ç‚¹ç±»ä¸º <code>VertexSBAPointXYZ</code>ï¼Œä¼˜åŒ–å˜é‡æ˜¯ 3 ç»´åº¦çš„ Vector3d å‘é‡ï¼›</li>
<li>é‡ç½®ä¸æ›´æ–°å‡½æ•°ç±»ä¼¼äºä¸¾ä¾‹ä¸€ä¸­çš„å½¢å¼ï¼Œç›´æ¥ç›¸åŠ ã€‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">VertexSBAPointXYZ</span> <span class="o">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="n">Vector3d</span><span class="o">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>    
    <span class="n">VertexSBAPointXYZ</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">setToOriginImpl</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">_estimate</span><span class="p">.</span><span class="n">fill</span><span class="p">(</span><span class="mf">0.</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">oplusImpl</span><span class="p">(</span><span class="k">const</span> <span class="kt">double</span><span class="o">*</span> <span class="n">update</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">Eigen</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Vector3d</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">(</span><span class="n">update</span><span class="p">);</span>
      <span class="n">_estimate</span> <span class="o">+=</span> <span class="n">v</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="13-å°†é¡¶ç‚¹æ·»åŠ åˆ°å›¾ä¸­">1.3 å°†é¡¶ç‚¹æ·»åŠ åˆ°å›¾ä¸­</h3>
<ul>
<li><strong>æ­¥éª¤ï¼š</strong>
<ul>
<li>â‘  åˆ›å»ºé¡¶ç‚¹</li>
<li>â‘¡ è®¾ç½®åˆå§‹å€¼</li>
<li>â‘¢ è®¾ç½®èŠ‚ç‚¹ç¼–å·</li>
<li>â‘£ æ·»åŠ åˆ°ä¼˜åŒ–å™¨ä¸­</li>
</ul>
</li>
<li><strong>ä¸¾ä¾‹ä¸€ï¼šæ›²çº¿æ‹Ÿåˆ</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">CurveFittingVertex</span><span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CurveFittingVertex</span><span class="p">();</span>
<span class="n">v</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">);</span>
<span class="n">v</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span><span class="p">(</span> <span class="n">v</span> <span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>ä¸¾ä¾‹äºŒï¼šä¸‰ç»´åæ ‡ç‚¹</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span> <span class="k">const</span> <span class="n">Point3f</span> <span class="nl">p</span><span class="p">:</span><span class="n">points_3d</span> <span class="p">)</span>   <span class="c1">// landmarks
</span><span class="c1"></span><span class="p">{</span>
<span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="o">*</span> <span class="n">point</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="p">();</span>
<span class="n">point</span><span class="o">-&gt;</span><span class="n">setId</span> <span class="p">(</span> <span class="n">index</span><span class="o">++</span> <span class="p">);</span>
<span class="n">point</span><span class="o">-&gt;</span><span class="n">setEstimate</span> <span class="p">(</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="p">(</span> <span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">z</span> <span class="p">)</span> <span class="p">);</span>
<span class="n">point</span><span class="o">-&gt;</span><span class="n">setMarginalized</span> <span class="p">(</span> <span class="nb">true</span> <span class="p">);</span> 
<span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span> <span class="p">(</span> <span class="n">point</span> <span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<hr>
<h2 id="2-g2o-ä¸­çš„è¾¹">2. g2o ä¸­çš„è¾¹</h2>
<h3 id="21-è¾¹çš„æ ¼å¼">2.1 è¾¹çš„æ ¼å¼</h3>
<p>â€ƒâ€ƒè¿˜æ˜¯å›åˆ°å‰é¢çš„ç±»å›¾ï¼Œå…³æ³¨å³ä¸Šè§’çš„è¾¹éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨çš„ç±»æ˜¯ <strong><code>BaseUnaryEdgeï¼ŒBaseBinaryEdgeï¼ŒBaseMultiEdge</code></strong> åˆ†åˆ«è¡¨ç¤º<strong>ä¸€å…ƒè¾¹ï¼Œä¸¤å…ƒè¾¹ï¼Œå¤šå…ƒè¾¹</strong>ï¼ˆä½äº g2o/g2o/core/base_edge.h ä¸­ï¼‰ï¼Œç±»ä¼¼äºé¡¶ç‚¹ï¼Œä»–ä»¬åˆç»§æ‰¿è‡ª <strong>OptimizableGraph::Edge</strong> ï¼ˆä½äº g2o/g2o/core/optimizable_graph.h ä¸­ï¼‰ï¼Œ<strong>hyper_graph::Edge</strong>ï¼ˆä½äº g2o/g2o/core/hyper_graph.h ä¸­ï¼‰ã€‚     <br>
â€ƒâ€ƒ<strong>ä¸€å…ƒè¾¹</strong>è¡¨ç¤ºåªè¿æ¥ä¸€ä¸ªé¡¶ç‚¹ï¼Œ<strong>äºŒå…ƒè¾¹</strong>è¡¨ç¤ºè¿æ¥ä¸¤ä¸ªé¡¶ç‚¹ï¼Œ<strong>å¤šå…ƒè¾¹</strong>è¡¨ç¤ºè¿æ¥ 3 ä¸ªæˆ–ä»¥ä¸Šé¡¶ç‚¹ã€‚
<img src="https://i.loli.net/2019/03/05/5c7df32d30e9d.png" alt=""></p>
<ul>
<li>ä¸»è¦<!-- raw HTML omitted --><strong>å‚æ•°æœ‰ï¼šD, E, VertexXi, VertexXj</strong><!-- raw HTML omitted -->
<ul>
<li>D æ˜¯ int å‹ï¼Œè¡¨ç¤º<strong>æµ‹é‡å€¼çš„ç»´åº¦</strong>ï¼›</li>
<li>E è¡¨ç¤º<strong>æµ‹é‡å€¼çš„æ•°æ®ç±»å‹</strong>ï¼›</li>
<li>VertexXiï¼ŒVertexXj åˆ†åˆ«è¡¨ç¤º<strong>ä¸åŒé¡¶ç‚¹çš„ç±»å‹</strong>ã€‚</li>
<li>ä¸¾ä¾‹ï¼šç”¨è¾¹è¡¨ç¤º<strong>ä¸‰ç»´ç‚¹æŠ•å½±åˆ°å›¾åƒå¹³é¢çš„é‡æŠ•å½±è¯¯å·®</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">BaseBinaryEdge</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="n">Vector2D</span><span class="p">,</span> <span class="n">VertexSBAPointXYZ</span><span class="p">,</span> <span class="n">VertexSE3Expmap</span><span class="o">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>é¦–å…ˆé¡¶ç‚¹æœ‰ä¸¤ä¸ªæ˜¯ä¸ªï¼Œè¿™æ˜¯ä¸€ä¸ªäºŒå…ƒè¾¹ï¼›</li>
<li>è¯¯å·®ï¼ˆæµ‹é‡å€¼ï¼‰çš„<strong>ç»´åº¦</strong>ä¸º 2ï¼Œä¹Ÿå°±æ˜¯åƒç´ åæ ‡ u,v çš„å·®å€¼ï¼›</li>
<li>è¯¯å·®ï¼ˆæµ‹é‡å€¼ï¼‰çš„<strong>æ•°æ®ç±»å‹</strong>ä¸ºäºŒç»´å‘é‡ Vector2Dï¼›</li>
<li>ä¸¤ä¸ª<strong>é¡¶ç‚¹ä¹Ÿå°±æ˜¯ä¼˜åŒ–å˜é‡</strong>åˆ†åˆ«æ˜¯ä¸‰ç»´ç‚¹  VertexSBAPointXYZ å’Œæç¾¤è¡¨ç¤ºçš„ç›¸æœºä½å§¿VertexSE3Expmapã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="22-è‡ªå®šä¹‰è¾¹">2.2 è‡ªå®šä¹‰è¾¹</h3>
<ul>
<li>è‡ªå®šä¹‰è¾¹éœ€è¦<!-- raw HTML omitted --><strong>é‡å†™ä»¥ä¸‹æˆå‘˜å‡½æ•°</strong><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">);</span>
<span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
<span class="k">virtual</span> <span class="kt">void</span> <span class="nf">computeError</span><span class="p">();</span>
<span class="k">virtual</span> <span class="kt">void</span> <span class="nf">linearizeOplus</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><strong><code>read()</code> å’Œ <code>write()</code> è¯»ç›˜ã€å­˜ç›˜å‡½æ•°</strong>ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸éœ€è¦è¿›è¡Œè¯»/å†™æ“ä½œçš„è¯ï¼Œä»…å£°æ˜ä¸€ä¸‹å°±å¯ä»¥äº†ï¼›</li>
<li><strong><code>computeError()</code></strong>ï¼šé‡è¦ï¼Œè®¡ç®—å½“å‰é¡¶ç‚¹<strong>è®¡ç®—å‡ºçš„æµ‹é‡å€¼ä¸çœŸå®çš„æµ‹é‡å€¼ä¹‹é—´çš„è¯¯å·®</strong>ï¼›</li>
<li><strong><code>linearizeOplus()</code></strong>ï¼šé‡è¦ï¼Œåœ¨å½“å‰é¡¶ç‚¹çš„å€¼ä¸‹ï¼Œè¯¥<strong>è¯¯å·®å¯¹ä¼˜åŒ–å˜é‡çš„åå¯¼æ•°ï¼Œä¹Ÿå°±æ˜¯ Jacobian</strong>ã€‚</li>
</ul>
</li>
<li>é™¤ä»¥ä¸Šå‡ ä¸ªæˆå‘˜å‡½æ•°ä¹‹å¤–è¿˜æœ‰å‡ ä¸ª<strong>é‡è¦çš„æˆå‘˜å˜é‡å’Œå‡½æ•°</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">_measurement</span><span class="err">ï¼šå­˜å‚¨è§‚æµ‹å€¼</span>
<span class="n">_error</span><span class="err">ï¼šå­˜å‚¨</span><span class="n">computeError</span><span class="p">()</span> <span class="err">å‡½æ•°è®¡ç®—çš„è¯¯å·®</span>
<span class="n">_vertices</span><span class="p">[]</span><span class="err">ï¼šå­˜å‚¨é¡¶ç‚¹ä¿¡æ¯ï¼Œæ¯”å¦‚äºŒå…ƒè¾¹çš„è¯ï¼Œ</span><span class="n">_vertices</span><span class="p">[]</span> <span class="err">çš„å¤§å°ä¸º</span><span class="mi">2</span><span class="err">ï¼Œå­˜å‚¨é¡ºåºå’Œè°ƒç”¨</span><span class="n">setVertex</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">vertex</span><span class="p">)</span> <span class="err">æ˜¯è®¾å®šçš„</span><span class="kt">int</span> <span class="err">æœ‰å…³ï¼ˆ</span><span class="mi">0</span> <span class="err">æˆ–</span><span class="mi">1</span><span class="err">ï¼‰</span>
<span class="n">setId</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="err">ï¼šæ¥å®šä¹‰è¾¹çš„ç¼–å·ï¼ˆå†³å®šäº†åœ¨</span><span class="n">HçŸ©é˜µä¸­çš„ä½ç½®</span><span class="err">ï¼‰</span>
<span class="n">setMeasurement</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="err">å‡½æ•°æ¥å®šä¹‰è§‚æµ‹å€¼</span>
<span class="n">setVertex</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">vertex</span><span class="p">)</span> <span class="err">æ¥å®šä¹‰é¡¶ç‚¹</span>
<span class="n">setInformation</span><span class="p">()</span> <span class="err">æ¥å®šä¹‰åæ–¹å·®çŸ©é˜µçš„é€†</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>è‡ªå®šä¹‰è¾¹çš„æ ¼å¼</strong>ï¼šç±»ä¼¼äºå®šä¹‰é¡¶ç‚¹ï¼Œä½†é‡ç‚¹æ˜¯ computeError()ï¼ŒlinearizeOplus() ä¸¤ä¸ªå‡½æ•°ï¼Œä¹Ÿæ›´å¤æ‚
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">myEdge</span><span class="o">:</span> <span class="k">public</span> <span class="n">g2o</span><span class="o">::</span><span class="n">BaseBinaryEdge</span><span class="o">&lt;</span><span class="n">errorDim</span><span class="p">,</span> <span class="n">errorType</span><span class="p">,</span> <span class="n">Vertex1Type</span><span class="p">,</span> <span class="n">Vertex2Type</span><span class="o">&gt;</span>
<span class="p">{</span>
      <span class="k">public</span><span class="o">:</span>
      <span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>      
      <span class="n">myEdge</span><span class="p">(){}</span>     
      <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">read</span><span class="p">(</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">in</span><span class="p">)</span> <span class="p">{}</span>
      <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">write</span><span class="p">(</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">out</span><span class="p">)</span> <span class="k">const</span> <span class="p">{}</span>  
        
      <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">computeError</span><span class="p">()</span> <span class="k">override</span>
      <span class="p">{</span>
          <span class="c1">// ...
</span><span class="c1"></span>          <span class="n">_error</span> <span class="o">=</span> <span class="n">_measurement</span> <span class="o">-</span> <span class="n">Something</span><span class="p">;</span>
      <span class="p">}</span>      
        
      <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">linearizeOplus</span><span class="p">()</span> <span class="k">override</span>
      <span class="p">{</span>
          <span class="n">_jacobianOplusXi</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span> <span class="o">=</span> <span class="n">something</span><span class="p">;</span>
          <span class="c1">// ...         
</span><span class="c1"></span>          <span class="cm">/*
</span><span class="cm">          _jocobianOplusXj(pos, pos) = something;
</span><span class="cm">          ...
</span><span class="cm">          */</span>
      <span class="p">}</span>      
      <span class="k">private</span><span class="o">:</span>
      <span class="c1">// data
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>ä¸¾ä¾‹ä¸€ï¼šä¸€å…ƒè¾¹</strong>ã€‚æ¥æº<a href="https://github.com/gaoxiang12/slambook/blob/master/ch6/g2o_curve_fitting/main.cpp">åå››è®²ä¸­çš„æ›²çº¿æ‹Ÿåˆ</a>
<ul>
<li>å®šä¹‰è¯¯å·®è¾¹ä¸º <code>CurveFittingEdge</code>ï¼Œç»´åº¦ä¸º 1ï¼Œç±»å‹ä¸º doubleï¼Œè¿æ¥çš„é¡¶ç‚¹ä¸º CurveFittingVertexï¼›</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">CurveFittingEdge</span><span class="o">:</span> <span class="k">public</span> <span class="n">g2o</span><span class="o">::</span><span class="n">BaseUnaryEdge</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="kt">double</span><span class="p">,</span><span class="n">CurveFittingVertex</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>
      
    <span class="n">CurveFittingEdge</span><span class="p">(</span> <span class="kt">double</span> <span class="n">x</span> <span class="p">)</span><span class="o">:</span> <span class="n">BaseUnaryEdge</span><span class="p">(),</span> <span class="n">_x</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{}</span>
      
    <span class="c1">// è®¡ç®—æ›²çº¿æ¨¡å‹è¯¯å·®
</span><span class="c1"></span>    <span class="kt">void</span> <span class="nf">computeError</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="n">CurveFittingVertex</span><span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">CurveFittingVertex</span><span class="o">*&gt;</span> <span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">const</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector3d</span> <span class="n">abc</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">();</span>
        <span class="n">_error</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">_measurement</span> <span class="o">-</span> <span class="n">std</span><span class="o">::</span><span class="n">exp</span><span class="p">(</span> <span class="n">abc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">_x</span><span class="o">*</span><span class="n">_x</span> <span class="o">+</span> <span class="n">abc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">_x</span> <span class="o">+</span> <span class="n">abc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span> <span class="p">;</span>
    <span class="p">}</span>
      
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">read</span><span class="p">(</span> <span class="n">istream</span><span class="o">&amp;</span> <span class="n">in</span> <span class="p">)</span> <span class="p">{}</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">write</span><span class="p">(</span> <span class="n">ostream</span><span class="o">&amp;</span> <span class="n">out</span> <span class="p">)</span> <span class="k">const</span> <span class="p">{}</span>
<span class="k">public</span><span class="o">:</span>
    <span class="kt">double</span> <span class="n">_x</span><span class="p">;</span>  <span class="c1">// x å€¼ï¼Œ y å€¼ä¸º _measurement
</span><span class="c1"></span><span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>ä¸¾ä¾‹äºŒï¼š äºŒå…ƒè¾¹</strong>ã€‚3D-2Dç‚¹çš„PnP é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æœ€å°åŒ–é‡æŠ•å½±è¯¯å·®é—®é¢˜ï¼Œæ¥æºäº g2o/types/sba/types_six_dof_expmap.h
<ul>
<li>æ„é€ è¾¹ä¸º <code>EdgeProjectXYZ2UV</code>ï¼Œç»´åº¦ä¸º 2ï¼Œç±»å‹ä¸º Vector2Dï¼Œ<strong>è¿æ¥çš„ä¸¤ä¸ªé¡¶ç‚¹</strong>åˆ†åˆ«ä¸º<strong>ä¸‰ç»´ç‚¹ VertexSBAPointXYZ</strong> å’Œ<strong>æç¾¤è¡¨ç¤ºçš„ç›¸æœºä½å§¿ VertexSE3Expmap</strong>ï¼›</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">//ç»§æ‰¿äº†BaseBinaryEdgeç±»ï¼Œè§‚æµ‹å€¼æ˜¯2ç»´ï¼Œç±»å‹Vector2D,é¡¶ç‚¹åˆ†åˆ«æ˜¯ä¸‰ç»´ç‚¹ã€æç¾¤ä½å§¿
</span><span class="c1"></span><span class="k">class</span> <span class="nc">G2O_TYPES_SBA_API</span> <span class="nl">EdgeProjectXYZ2UV</span> <span class="p">:</span> <span class="k">public</span>  <span class="n">BaseBinaryEdge</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="n">Vector2D</span><span class="p">,</span> <span class="n">VertexSBAPointXYZ</span><span class="p">,</span> <span class="n">VertexSE3Expmap</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
    <span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span><span class="p">;</span>
      
    <span class="c1">//1. æ„é€ å‡½æ•°åˆå§‹åŒ–
</span><span class="c1"></span>    <span class="n">EdgeProjectXYZ2UV</span><span class="p">();</span>
      
    <span class="c1">//2. è®¡ç®—è¯¯å·®
</span><span class="c1"></span>    <span class="kt">void</span> <span class="nf">computeError</span><span class="p">()</span>  
    <span class="p">{</span>
      <span class="c1">// æç¾¤ç›¸æœºä½å§¿ é¡¶ç‚¹ v1
</span><span class="c1"></span>      <span class="k">const</span> <span class="n">VertexSE3Expmap</span><span class="o">*</span> <span class="n">v1</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">VertexSE3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="c1">// ä¸‰ç»´ç‚¹ é¡¶ç‚¹ v2
</span><span class="c1"></span>      <span class="k">const</span> <span class="n">VertexSBAPointXYZ</span><span class="o">*</span> <span class="n">v2</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">VertexSBAPointXYZ</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="c1">//ç›¸æœºå‚æ•°
</span><span class="c1"></span>      <span class="k">const</span> <span class="n">CameraParameters</span> <span class="o">*</span> <span class="n">cam</span>
        <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">CameraParameters</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">parameter</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
     <span class="c1">//è¯¯å·®è®¡ç®—ï¼Œæµ‹é‡å€¼å‡å»ä¼°è®¡å€¼ï¼Œä¹Ÿå°±æ˜¯é‡æŠ•å½±è¯¯å·®obs-cam
</span><span class="c1"></span>     <span class="c1">//ä¼°è®¡å€¼è®¡ç®—æ–¹æ³•æ˜¯T*p,å¾—åˆ°ç›¸æœºåæ ‡ç³»ä¸‹åæ ‡ï¼Œç„¶ååœ¨åˆ©ç”¨camera2pixel()å‡½æ•°å¾—åˆ°åƒç´ åæ ‡ã€‚
</span><span class="c1"></span>      <span class="n">Vector2D</span> <span class="n">obs</span><span class="p">(</span><span class="n">_measurement</span><span class="p">);</span>
      <span class="n">_error</span> <span class="o">=</span> <span class="n">obs</span><span class="o">-</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">cam_map</span><span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">v2</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">()));</span>
    <span class="p">}</span>
      
    <span class="c1">//3. çº¿æ€§å¢é‡å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯é›…å…‹æ¯”çŸ©é˜µJçš„è®¡ç®—æ–¹æ³•
</span><span class="c1"></span>    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">linearizeOplus</span><span class="p">();</span>
      
    <span class="c1">//4. ç›¸æœºå‚æ•°
</span><span class="c1"></span>    <span class="n">CameraParameters</span> <span class="o">*</span> <span class="n">_cam</span><span class="p">;</span> 
    <span class="kt">bool</span> <span class="nf">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>å…³äº<!-- raw HTML omitted --><strong>è¯¯å·®è®¡ç®—å‡½æ•°ï¼šè¯¯å·® = è§‚æµ‹ - æŠ•å½±</strong><!-- raw HTML omitted -->
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">_error</span> <span class="o">=</span> <span class="n">obs</span> <span class="o">-</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">cam_map</span><span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">v2</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">()));</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>å…¶ä¸­ obs æ˜¯è§‚æµ‹å€¼ï¼Œå½“å‰å¸§ä¸­è§‚å¯Ÿåˆ°çš„ç‰¹å¾ç‚¹çš„åƒç´ åæ ‡ï¼›</li>
<li>v1 æ˜¯ç›¸æœºä½å§¿ï¼Œv2 æ˜¯åœ°å›¾ç‚¹åæ ‡ï¼Œcam æ˜¯ç›¸æœºå‚æ•°ï¼›</li>
<li><code>v1-&gt;estimate().map(v2-&gt;estimate())</code> æ˜¯<strong>åˆ©ç”¨ç›¸æœºä½å§¿ï¼ˆå¤–å‚ï¼‰å°†åœ°å›¾ç‚¹åæ ‡ä»ä¸–ç•Œåæ ‡ç³»è½¬æ¢åˆ°ç›¸æœºåæ ‡ç³»</strong>ï¼›ï¼ˆ.map æ“ä½œå®šä¹‰åœ¨ g2o/types/sim3/sim3.h ä¸­ï¼‰</li>
<li><code>cam-&gt;cam_map(v1-&gt;estimate().map(v2-&gt;estimate()))</code> æ˜¯<strong>åˆ©ç”¨ç›¸æœºå†…å‚å°†åœ°å›¾ç‚¹ä»ç›¸æœºåæ ‡ç³»è½¬æ¢åˆ°å›¾åƒåæ ‡ç³»</strong>ã€‚ï¼ˆcam_map æ“ä½œå®šä¹‰åœ¨ g2o/types/sba/types_six_dof_expmap.cpp ä¸­ï¼‰</li>
</ul>
</li>
<li>å…³äº<!-- raw HTML omitted --><strong>é›…å…‹æ¯”çŸ©é˜µ</strong>çš„è®¡ç®—å‡½æ•° <strong><code>linearizeOplus()</code></strong>ï¼š<strong>è¯¯å·®ï¼ˆè§‚æµ‹ç›¸æœºæ–¹ç¨‹ï¼‰å…³äºç›¸æœºä½å§¿å’Œä¸‰ç»´ç‚¹çš„åå¯¼æ•°</strong><!-- raw HTML omitted -->
<img src="https://img-blog.csdnimg.cn/20190914172413878.png#pic_center" alt="">
<img src="https://img-blog.csdnimg.cn/2019091417243290.png#pic_center" alt="">
<ul>
<li>ä¸Šå¼åˆ†åˆ«å¯¹åº”ä¸‹é¢ä»£ç ä¸­çš„ <strong>_jacobianOplusXj</strong> å’Œ <strong>_jacobianOplusXi</strong>ï¼ˆä»£ç ä½äº g2o/g2o/types/sba/types_six_dof_expmap.cpp ä¸­ï¼‰
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp">  <span class="kt">void</span> <span class="n">EdgeProjectXYZ2UV</span><span class="o">::</span><span class="n">linearizeOplus</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">VertexSE3Expmap</span> <span class="o">*</span> <span class="n">vj</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">VertexSE3Expmap</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="n">SE3Quat</span> <span class="nf">T</span><span class="p">(</span><span class="n">vj</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">());</span>
  <span class="n">VertexSBAPointXYZ</span><span class="o">*</span> <span class="n">vi</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">VertexSBAPointXYZ</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">Vector3D</span> <span class="n">xyz</span> <span class="o">=</span> <span class="n">vi</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">();</span>
  <span class="n">Vector3D</span> <span class="n">xyz_trans</span> <span class="o">=</span> <span class="n">T</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">xyz</span><span class="p">);</span>

  <span class="kt">double</span> <span class="n">x</span> <span class="o">=</span> <span class="n">xyz_trans</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xyz_trans</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">z</span> <span class="o">=</span> <span class="n">xyz_trans</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">z_2</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">;</span>

  <span class="k">const</span> <span class="n">CameraParameters</span> <span class="o">*</span> <span class="n">cam</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">CameraParameters</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">parameter</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

  <span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">Eigen</span><span class="o">::</span><span class="n">ColMajor</span><span class="o">&gt;</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="n">tmp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">focal_length</span><span class="p">;</span>
  <span class="n">tmp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">tmp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="o">/</span><span class="n">z</span><span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">focal_length</span><span class="p">;</span>

  <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">focal_length</span><span class="p">;</span>
  <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span><span class="o">/</span><span class="n">z</span><span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">focal_length</span><span class="p">;</span>

  <span class="n">_jacobianOplusXi</span> <span class="o">=</span>  <span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">T</span><span class="p">.</span><span class="n">rotation</span><span class="p">().</span><span class="n">toRotationMatrix</span><span class="p">();</span>

  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span>  <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="n">z_2</span> <span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">focal_length</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">z_2</span><span class="p">))</span> <span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">focal_length</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">focal_length</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">focal_length</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span><span class="o">/</span><span class="n">z_2</span> <span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">focal_length</span><span class="p">;</span>

  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="n">z_2</span><span class="p">)</span> <span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">focal_length</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="n">z_2</span> <span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">focal_length</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">focal_length</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">focal_length</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span><span class="o">/</span><span class="n">z_2</span> <span class="o">*</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">focal_length</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="23-å°†è¾¹æ·»åŠ åˆ°å›¾ä¸­">2.3 å°†è¾¹æ·»åŠ åˆ°å›¾ä¸­</h3>
<ul>
<li>
<p><strong>ä¸¾ä¾‹ä¸€ï¼šä¸€å…ƒè¾¹ã€‚</strong> ä»¥æ›²çº¿æ‹Ÿåˆä¸ºä¾‹ï¼ˆslambook/ch6/g2o_curve_fitting/main.cppï¼‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">N</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// åˆ›å»ºè¾¹
</span><span class="c1"></span>    <span class="n">CurveFittingEdge</span><span class="o">*</span> <span class="n">edge</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CurveFittingEdge</span><span class="p">(</span> <span class="n">x_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span>
      
    <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>                         <span class="c1">// è®¾ç½®è¾¹çš„ id
</span><span class="c1"></span>    <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">v</span> <span class="p">);</span>                <span class="c1">// è®¾ç½®è¿æ¥çš„é¡¶ç‚¹
</span><span class="c1"></span>    <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setMeasurement</span><span class="p">(</span> <span class="n">y_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span>      <span class="c1">// è§‚æµ‹æ•°å€¼
</span><span class="c1"></span>      
    <span class="c1">// ä¿¡æ¯çŸ©é˜µï¼šåæ–¹å·®çŸ©é˜µä¹‹é€†
</span><span class="c1"></span>    <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setInformation</span><span class="p">(</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;::</span><span class="n">Identity</span><span class="p">()</span><span class="o">*</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">w_sigma</span><span class="o">*</span><span class="n">w_sigma</span><span class="p">)</span> <span class="p">);</span> 
      
    <span class="c1">// å°†è¾¹æ·»åŠ åˆ°å›¾ä¸­
</span><span class="c1"></span>    <span class="n">optimizer</span><span class="p">.</span><span class="n">addEdge</span><span class="p">(</span> <span class="n">edge</span> <span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>ä¸¾ä¾‹äºŒï¼šäºŒå…ƒè¾¹ã€‚</strong> ä½äº slambook/ch7/pose_estimation_3d2d.cpp ä¸­</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span> <span class="k">const</span> <span class="n">Point2f</span> <span class="nl">p</span><span class="p">:</span><span class="n">points_2d</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// åˆ›å»ºè¾¹.
</span><span class="c1"></span>    <span class="n">g2o</span><span class="o">::</span><span class="n">EdgeProjectXYZ2UV</span><span class="o">*</span> <span class="n">edge</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">EdgeProjectXYZ2UV</span><span class="p">();</span>
    <span class="c1">// è®¾ç½®è¾¹çš„ id
</span><span class="c1"></span>    <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setId</span> <span class="p">(</span> <span class="n">index</span> <span class="p">);</span>
    <span class="c1">// æŒ‡å®šè¿æ¥çš„é¡¶ç‚¹
</span><span class="c1"></span>    <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setVertex</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="o">*&gt;</span> <span class="p">(</span> <span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span> <span class="p">(</span> <span class="n">index</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
    <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setVertex</span> <span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pose</span> <span class="p">);</span>
      
    <span class="c1">// è®¾ç½®è§‚æµ‹å€¼
</span><span class="c1"></span>    <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setMeasurement</span> <span class="p">(</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Vector2d</span> <span class="p">(</span> <span class="n">p</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">y</span> <span class="p">)</span> <span class="p">);</span>
      
    <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setParameterId</span> <span class="p">(</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="p">);</span>
      
    <span class="n">edge</span><span class="o">-&gt;</span><span class="n">setInformation</span> <span class="p">(</span> <span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix2d</span><span class="o">::</span><span class="n">Identity</span><span class="p">()</span> <span class="p">);</span>
      
    <span class="n">optimizer</span><span class="p">.</span><span class="n">addEdge</span> <span class="p">(</span> <span class="n">edge</span> <span class="p">);</span>
    <span class="n">index</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>æ³¨æ„åœ¨ <strong>setVertex() ä¸­è®¾ç½®é¡¶ç‚¹çš„ id å’Œç±»å‹æ—¶è¦ä¸è¾¹çš„ç±»ä¸­å®šä¹‰çš„ç›¸å¯¹åº”</strong>ï¼Œæ¯”å¦‚å®šä¹‰è¾¹æ—¶ v1 è¡¨ç¤ºç›¸æœºä½å§¿ï¼Œid ä¸º 1ï¼Œv2 è¡¨ç¤ºä¸‰ç»´ç‚¹ï¼Œid ä¸º0
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">G2O_TYPES_SBA_API</span> <span class="n">EdgeProjectXYZ2UV</span> 
<span class="p">.....</span>
 <span class="c1">//æç¾¤ç›¸æœºä½å§¿v1
</span><span class="c1"></span><span class="k">const</span> <span class="n">VertexSE3Expmap</span><span class="o">*</span> <span class="n">v1</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">VertexSE3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="c1">// é¡¶ç‚¹v2
</span><span class="c1"></span><span class="k">const</span> <span class="n">VertexSBAPointXYZ</span><span class="o">*</span> <span class="n">v2</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">VertexSBAPointXYZ</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<hr>
<h2 id="3-orb-slam2-ä¸­çš„é¡¶ç‚¹">3. ORB-SLAM2 ä¸­çš„é¡¶ç‚¹</h2>
<ul>
<li>å‰ä¸€ç¯‡æ–‡ç« ç¬”è®°æåˆ°åœ¨ ORB-SLAM2 ä¸­<strong>é¡¶ç‚¹</strong>æœ‰ä¸‰ä¸ªï¼Œ<strong>SE(3) ç›¸æœºä½å§¿</strong>ã€<strong>åœ°å›¾ç‚¹åæ ‡</strong>ã€<strong>é—­ç¯æ£€æµ‹æ—¶çš„ sim(3) ç›¸æœºä½å§¿</strong>ï¼›
<ul>
<li>åœ¨<strong>æ¯å¸§çš„ä½å§¿ä¼˜åŒ–</strong> Optimizer::PoseOptimization() å‡½æ•°ä¸­åªå°†ç›¸æœºä½å§¿ä½œä¸ºé¡¶ç‚¹ï¼›</li>
<li>åœ¨ <strong>BA ä¼˜åŒ–</strong> ä¸­å°†ç›¸æœºä½å§¿å’Œåœ°å›¾ç‚¹ä¸¤è€…ä½œä¸ºé¡¶ç‚¹ï¼›</li>
<li>åœ¨<strong>é—­ç¯æ—¶</strong>å°† sim(3) ç›¸æœºä½å§¿ä½œä¸ºé¡¶ç‚¹ã€‚</li>
</ul>
</li>
</ul>
<h3 id="31-ç›¸æœºä½å§¿é¡¶ç‚¹">3.1 ç›¸æœºä½å§¿é¡¶ç‚¹</h3>
<ul>
<li>ä¸å‰é¢<strong>è‡ªå®šä¹‰é¡¶ç‚¹çš„ä¸¾ä¾‹äºŒ</strong>ä¸­ä¸€æ ·ï¼Œå³ g2o/types/types_six_dof_expmap.h ä¸­ <strong>6 ç»´æä»£æ•°è¡¨ç¤ºçš„ VertexSE3Expmap</strong>ã€‚</li>
</ul>
<h3 id="32-åœ°å›¾ç‚¹åæ ‡é¡¶ç‚¹">3.2 åœ°å›¾ç‚¹åæ ‡é¡¶ç‚¹</h3>
<ul>
<li>ä¸å‰é¢<strong>è‡ªå®šä¹‰é¡¶ç‚¹çš„ä¸¾ä¾‹ä¸‰</strong>ä¸­ä¸€æ ·ï¼Œå³ g2o/types/types_sba.h ä¸­<strong>ä¸‰ç»´å‘é‡è¡¨ç¤ºçš„ VertexSBAPointXYZ</strong>ã€‚</li>
</ul>
<h3 id="33-é—­ç¯æ—¶çš„-sim3-ç›¸æœºä½å§¿">3.3 é—­ç¯æ—¶çš„ sim3 ç›¸æœºä½å§¿</h3>
<ul>
<li>ä¸ 6 ç»´æä»£æ•°è¡¨ç¤ºçš„ç›¸æœºä¸ºäº†å¤šäº†ä¸€ä¸ªå°ºåº¦å› å­
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// BRIEF 7 ç»´ Sim3 è¡¨ç¤ºçš„ç›¸æœºä½å§¿.ï¼ˆç”¨äºé—­ç¯ï¼‰ï¼Œå¢åŠ äº†ä¸€ä¸ªå°ºåº¦ s.
</span><span class="c1"></span>  <span class="k">class</span> <span class="nc">VertexSim3Expmap</span> <span class="o">:</span> <span class="k">public</span> <span class="n">BaseVertex</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">,</span> <span class="n">Sim3</span><span class="o">&gt;</span>
  <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>

    <span class="n">VertexSim3Expmap</span><span class="p">();</span>

    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

    <span class="c1">// é‡ç½®å‡½æ•°ï¼Œå°ºåº¦å› å­ s è®¾ç½®ä¸º 1.
</span><span class="c1"></span>    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">setToOriginImpl</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">_estimate</span> <span class="o">=</span> <span class="n">Sim3</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// é¡¶ç‚¹æ›´æ–°å‡½æ•°.
</span><span class="c1"></span>    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">oplusImpl</span><span class="p">(</span><span class="k">const</span> <span class="kt">double</span><span class="o">*</span> <span class="n">update_</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">Eigen</span><span class="o">::</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Vector7d</span><span class="o">&gt;</span> <span class="n">update</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">update_</span><span class="p">));</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">_fix_scale</span><span class="p">)</span>
        <span class="n">update</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="n">Sim3</span> <span class="n">s</span><span class="p">(</span><span class="n">update</span><span class="p">);</span>
      <span class="n">setEstimate</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">estimate</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="n">Vector2d</span> <span class="n">_principle_point1</span><span class="p">,</span> <span class="n">_principle_point2</span><span class="p">;</span>
    <span class="n">Vector2d</span> <span class="n">_focal_length1</span><span class="p">,</span> <span class="n">_focal_length2</span><span class="p">;</span>

    <span class="c1">// åœ°å›¾ç‚¹æŠ•å½±åˆ°é—­ç¯å¸§çš„åæ ‡ï¼Ÿ
</span><span class="c1"></span>    <span class="n">Vector2d</span> <span class="nf">cam_map1</span><span class="p">(</span><span class="k">const</span> <span class="n">Vector2d</span> <span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="k">const</span>
    <span class="p">{</span>
      <span class="n">Vector2d</span> <span class="n">res</span><span class="p">;</span>
      <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">_focal_length1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">_principle_point1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">_focal_length1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">_principle_point1</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// åœ°å›¾ç‚¹æŠ•å½±åˆ°å½“å‰å¸§çš„åæ ‡ï¼Ÿ
</span><span class="c1"></span>    <span class="n">Vector2d</span> <span class="nf">cam_map2</span><span class="p">(</span><span class="k">const</span> <span class="n">Vector2d</span> <span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="k">const</span>
    <span class="p">{</span>
      <span class="n">Vector2d</span> <span class="n">res</span><span class="p">;</span>
      <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">_focal_length2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">_principle_point2</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">_focal_length2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">_principle_point2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">bool</span> <span class="n">_fix_scale</span><span class="p">;</span>


  <span class="k">protected</span><span class="o">:</span>
  <span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<hr>
<h2 id="4-orb-slam2-ä¸­çš„è¾¹">4. ORB-SLAM2 ä¸­çš„è¾¹</h2>
<h3 id="41-ä½å§¿ä¼˜åŒ–æ—¶çš„é‡æŠ•å½±è¯¯å·®">4.1 ä½å§¿ä¼˜åŒ–æ—¶çš„é‡æŠ•å½±è¯¯å·®</h3>
<ul>
<li>åœ¨ PoseOptimization() <strong>ä»…ä¼˜åŒ–ç›¸æœºä½å§¿</strong> æ—¶ï¼Œé‡æŠ•å½±è¯¯å·®æ˜¯ä¸€ä¸ª<strong>ä¸€å…ƒè¾¹</strong>ï¼Œé¡¶ç‚¹ï¼ˆä¼˜åŒ–å˜é‡ï¼‰ä¸º<strong>ç›¸æœºçš„ä½å§¿</strong>ã€‚å¯¹åº” g2o/types/types_six_dof_expmap.h ä¸­å®šä¹‰çš„è¾¹ <strong>EdgeSE3ProjectXYZOnlyPose</strong>ã€‚
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// BRIEF ä¸€å…ƒè¾¹ï¼šé‡æŠ•å½±è¯¯å·®ï¼ˆä»…ç”¨äºä¼˜åŒ–ç›¸æœºä½å§¿æ—¶ï¼‰
</span><span class="c1"></span><span class="k">class</span>  <span class="nc">EdgeSE3ProjectXYZOnlyPose</span><span class="o">:</span> <span class="k">public</span>  <span class="n">BaseUnaryEdge</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="n">Vector2d</span><span class="p">,</span> <span class="n">VertexSE3Expmap</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>

  <span class="n">EdgeSE3ProjectXYZOnlyPose</span><span class="p">(){}</span>

  <span class="kt">bool</span> <span class="nf">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">);</span>

  <span class="kt">bool</span> <span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">// è¯¯å·®è®¡ç®—å‡½æ•°.
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">computeError</span><span class="p">()</span>  
  <span class="p">{</span>
    <span class="c1">// æä»£æ•°è¡¨ç¤ºçš„ç›¸æœºä½å§¿ v1ï¼ˆé¡¶ç‚¹ï¼‰.
</span><span class="c1"></span>    <span class="k">const</span> <span class="n">VertexSE3Expmap</span><span class="o">*</span> <span class="n">v1</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">VertexSE3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

    <span class="c1">// è§‚æµ‹å€¼ï¼šç‰¹å¾ç‚¹å½“å‰å¸§ä¸­çš„åæ ‡.
</span><span class="c1"></span>    <span class="n">Vector2d</span> <span class="n">obs</span><span class="p">(</span><span class="n">_measurement</span><span class="p">);</span>

    <span class="c1">// é‡æŠ•å½±è¯¯å·®ï¼Œ.map() æ˜¯å°†åœ°å›¾ç‚¹çš„ä¸–ç•Œåæ ‡è½¬æ¢åˆ°ç›¸æœºåæ ‡ç³»ï¼Œcam_project() æ“ä½œå°†å…¶æŠ•å½±åˆ°å½“å‰å¸§.
</span><span class="c1"></span>    <span class="n">_error</span> <span class="o">=</span> <span class="n">obs</span><span class="o">-</span><span class="n">cam_project</span><span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">Xw</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="c1">// æ£€æŸ¥åœ°å›¾ç‚¹åœ¨ç›¸æœºåæ ‡ç³»ä¸­çš„æ·±åº¦æ˜¯å¦ä¸ºæ­£.
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="nf">isDepthPositive</span><span class="p">()</span> 
  <span class="p">{</span>
    <span class="k">const</span> <span class="n">VertexSE3Expmap</span><span class="o">*</span> <span class="n">v1</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">VertexSE3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">Xw</span><span class="p">))(</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// é›…å…‹æ¯”çŸ©é˜µï¼šé‡æŠ•å½±è¯¯å·®ç›¸å¯¹äºç›¸æœºä½å§¿çš„ä¸€é˜¶å¯¼.
</span><span class="c1"></span>  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">linearizeOplus</span><span class="p">();</span>

  <span class="c1">// æŠ•å½±åˆ°å½“å‰å¸§.
</span><span class="c1"></span>  <span class="n">Vector2d</span> <span class="nf">cam_project</span><span class="p">(</span><span class="k">const</span> <span class="n">Vector3d</span> <span class="o">&amp;</span> <span class="n">trans_xyz</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="n">Vector3d</span> <span class="n">Xw</span><span class="p">;</span>  <span class="c1">// åœ°å›¾ç‚¹çš„ä¸–ç•Œåæ ‡.
</span><span class="c1"></span>
  <span class="kt">double</span> <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">;</span>  <span class="c1">// ç›¸æœºå‚æ•°.
</span><span class="c1"></span><span class="p">};</span> <span class="c1">// è¾¹ï¼šé‡æŠ•å½±è¯¯å·®ï¼ˆä»…ç”¨äºä¼˜åŒ–ç›¸æœºä½å§¿æ—¶ï¼‰.
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å…¶ä¸­ linearizeOplus() å‡½æ•°<strong>æ„é€ é›…å…‹æ¯”çŸ©é˜µ</strong>ï¼Œå¯¹åº” <code>g2o/types/types_six_dof_expmap.cpp</code> ä¸­çš„ <code>void EdgeSE3ProjectXYZOnlyPose::linearizeOplus()</code>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// BRIEF ä¼˜åŒ–ç›¸æœºä½å§¿æ˜¯é‡æŠ•å½±è¯¯å·®çš„é›…å…‹æ¯”çŸ©é˜µï¼ˆå¯¹ç›¸æœºä½å§¿çš„åå¯¼ï¼‰
</span><span class="c1"></span><span class="kt">void</span> <span class="n">EdgeSE3ProjectXYZOnlyPose</span><span class="o">::</span><span class="n">linearizeOplus</span><span class="p">()</span> 
<span class="p">{</span>
  <span class="c1">// é¡¶ç‚¹ï¼šç›¸æœºä½å§¿.
</span><span class="c1"></span>  <span class="n">VertexSE3Expmap</span> <span class="o">*</span> <span class="n">vi</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">VertexSE3Expmap</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="c1">// åœ°å›¾ç‚¹çš„ç›¸æœºåæ ‡.
</span><span class="c1"></span>  <span class="n">Vector3d</span> <span class="n">xyz_trans</span> <span class="o">=</span> <span class="n">vi</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">Xw</span><span class="p">);</span>

  <span class="kt">double</span> <span class="n">x</span> <span class="o">=</span> <span class="n">xyz_trans</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xyz_trans</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">invz</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">xyz_trans</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">invz_2</span> <span class="o">=</span> <span class="n">invz</span><span class="o">*</span><span class="n">invz</span><span class="p">;</span>

  <span class="n">_jacobianOplusXi</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span>  <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">invz_2</span> <span class="o">*</span><span class="n">fx</span><span class="p">;</span>
  <span class="n">_jacobianOplusXi</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">invz_2</span><span class="p">))</span> <span class="o">*</span><span class="n">fx</span><span class="p">;</span>
  <span class="n">_jacobianOplusXi</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">invz</span> <span class="o">*</span><span class="n">fx</span><span class="p">;</span>
  <span class="n">_jacobianOplusXi</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">invz</span> <span class="o">*</span><span class="n">fx</span><span class="p">;</span>
  <span class="n">_jacobianOplusXi</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">_jacobianOplusXi</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">invz_2</span> <span class="o">*</span><span class="n">fx</span><span class="p">;</span>

  <span class="n">_jacobianOplusXi</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">invz_2</span><span class="p">)</span> <span class="o">*</span><span class="n">fy</span><span class="p">;</span>
  <span class="n">_jacobianOplusXi</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">invz_2</span> <span class="o">*</span><span class="n">fy</span><span class="p">;</span>
  <span class="n">_jacobianOplusXi</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">invz</span> <span class="o">*</span><span class="n">fy</span><span class="p">;</span>
  <span class="n">_jacobianOplusXi</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">_jacobianOplusXi</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">invz</span> <span class="o">*</span><span class="n">fy</span><span class="p">;</span>
  <span class="n">_jacobianOplusXi</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">invz_2</span> <span class="o">*</span><span class="n">fy</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">// ä¼˜åŒ–ç›¸æœºä½å§¿æ˜¯é‡æŠ•å½±è¯¯å·®çš„é›…å…‹æ¯”çŸ©é˜µ.
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h3 id="42-ba-ä¼˜åŒ–æ—¶çš„é‡æŠ•å½±è¯¯å·®">4.2 BA ä¼˜åŒ–æ—¶çš„é‡æŠ•å½±è¯¯å·®</h3>
<ul>
<li>åœ¨ <strong>BA ä¼˜åŒ–æ—¶ä¼˜åŒ–çš„é‡åŒ…æ‹¬ç›¸æœºä½å§¿å’Œåœ°å›¾ç‚¹åæ ‡ï¼Œé‡æŠ•å½±è¯¯å·®æ˜¯ä¸€ä¸ªäºŒå…ƒè¾¹</strong>ï¼Œè¿æ¥çš„é¡¶ç‚¹ä¸ºæä»£æ•°è¡¨ç¤ºçš„ç›¸æœºä½å§¿å’Œä¸‰ç»´å‘é‡è¡¨ç¤ºçš„åœ°å›¾ç‚¹åæ ‡ã€‚å¯¹åº” g2o/types/types_six_dof_expmap.h ä¸­å®šä¹‰çš„è¾¹ <strong>EdgeSE3ProjectXYZ</strong>ï¼Œå…¶å®šä¹‰æ ¼å¼ä¸å‰é¢è‡ªå®šä¹‰è¾¹ä¸­ä¸¾ä¾‹äºŒçš„äºŒå…ƒè¾¹ä¸€æ ·ã€‚
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// BRIEF è¾¹ï¼šé‡æŠ•å½±è¯¯å·®ï¼ˆBAä¼˜åŒ–æ—¶ï¼‰
</span><span class="c1"></span><span class="k">class</span>  <span class="nc">EdgeSE3ProjectXYZ</span><span class="o">:</span> <span class="k">public</span>  <span class="n">BaseBinaryEdge</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="n">Vector2d</span><span class="p">,</span> <span class="n">VertexSBAPointXYZ</span><span class="p">,</span> <span class="n">VertexSE3Expmap</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>

  <span class="n">EdgeSE3ProjectXYZ</span><span class="p">();</span>

  <span class="kt">bool</span> <span class="nf">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">);</span>

  <span class="kt">bool</span> <span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">// è¯¯å·®è®¡ç®—å‡½æ•°
</span><span class="c1"></span>  <span class="kt">void</span> <span class="nf">computeError</span><span class="p">()</span>  
  <span class="p">{</span>
    <span class="c1">// é¡¶ç‚¹ v1ï¼šç›¸æœºä½å§¿ï¼Œé¡¶ç‚¹çš„ id ä¸º 1.
</span><span class="c1"></span>    <span class="k">const</span> <span class="n">VertexSE3Expmap</span><span class="o">*</span> <span class="n">v1</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">VertexSE3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="c1">// é¡¶ç‚¹ v2ï¼šåœ°å›¾ç‚¹ï¼Œé¡¶ç‚¹çš„ id ä¸º 0.
</span><span class="c1"></span>    <span class="k">const</span> <span class="n">VertexSBAPointXYZ</span><span class="o">*</span> <span class="n">v2</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">VertexSBAPointXYZ</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="c1">// è§‚æµ‹å€¼ï¼šç‰¹å¾ç‚¹åœ¨å½“å‰å¸§ä¸­çš„åƒç´ åæ ‡.
</span><span class="c1"></span>    <span class="n">Vector2d</span> <span class="n">obs</span><span class="p">(</span><span class="n">_measurement</span><span class="p">);</span>
    <span class="c1">// è®¡ç®—è¯¯å·®ï¼šè§‚æµ‹-é‡æŠ•å½±.
</span><span class="c1"></span>    <span class="n">_error</span> <span class="o">=</span> <span class="n">obs</span><span class="o">-</span><span class="n">cam_project</span><span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">v2</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">()));</span>
  <span class="p">}</span>

  <span class="c1">// æ£€æŸ¥åœ°å›¾ç‚¹åœ¨ç›¸æœºåæ ‡ç³»ä¸­æ·±åº¦æ˜¯å¦ä¸ºæ­£.
</span><span class="c1"></span>  <span class="kt">bool</span> <span class="nf">isDepthPositive</span><span class="p">()</span> 
  <span class="p">{</span>
    <span class="k">const</span> <span class="n">VertexSE3Expmap</span><span class="o">*</span> <span class="n">v1</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">VertexSE3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">const</span> <span class="n">VertexSBAPointXYZ</span><span class="o">*</span> <span class="n">v2</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">VertexSBAPointXYZ</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">v2</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">()))(</span><span class="mi">2</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// æ„é€ é›…å…‹æ¯”çŸ©é˜µï¼šé‡æŠ•å½±è¯¯å·®ç›¸å¯¹äºç›¸æœºåæ ‡å’Œåœ°å›¾ç‚¹çš„ä¸€é˜¶å¯¼.
</span><span class="c1"></span>  <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">linearizeOplus</span><span class="p">();</span>

  <span class="c1">// æŠ•å½±åˆ°å½“å‰å¸§.
</span><span class="c1"></span>  <span class="n">Vector2d</span> <span class="nf">cam_project</span><span class="p">(</span><span class="k">const</span> <span class="n">Vector3d</span> <span class="o">&amp;</span> <span class="n">trans_xyz</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="kt">double</span> <span class="n">fx</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">;</span>
<span class="p">};</span> <span class="c1">// è¾¹ï¼šé‡æŠ•å½±è¯¯å·®ï¼ˆBAä¼˜åŒ–æ—¶ï¼‰.
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>å…¶ä¸­ linearizeOplus() å‡½æ•°ç”¨äº<strong>æ„é€ é›…å…‹æ¯”çŸ©é˜µï¼Œéœ€è¦é‡æŠ•å½±è¯¯å·®å¯¹ç›¸æœºä½å§¿å’Œåœ°å›¾ç‚¹æ±‚ä¸€é˜¶åå¯¼</strong>ï¼Œå¯¹åº” g2o/types/types_six_dof_expmap.cpp ä¸­çš„ void EdgeSE3ProjectXYZ::linearizeOplus() ã€‚
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// BRIEF é‡æŠ•å½±è¯¯å·®çš„é›…å…‹æ¯”çŸ©é˜µï¼ˆBA ä¼˜åŒ–æ—¶ç›¸å¯¹äºç›¸æœºä½å§¿å’Œåœ°å›¾ç‚¹çš„ä¸€é˜¶å¯¼ï¼‰
</span><span class="c1"></span><span class="kt">void</span> <span class="n">EdgeSE3ProjectXYZ</span><span class="o">::</span><span class="n">linearizeOplus</span><span class="p">()</span> 
<span class="p">{</span>
  <span class="n">VertexSE3Expmap</span> <span class="o">*</span> <span class="n">vj</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">VertexSE3Expmap</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="n">SE3Quat</span> <span class="nf">T</span><span class="p">(</span><span class="n">vj</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">());</span>
  <span class="n">VertexSBAPointXYZ</span><span class="o">*</span> <span class="n">vi</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">VertexSBAPointXYZ</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">Vector3d</span> <span class="n">xyz</span> <span class="o">=</span> <span class="n">vi</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">();</span>
  <span class="n">Vector3d</span> <span class="n">xyz_trans</span> <span class="o">=</span> <span class="n">T</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">xyz</span><span class="p">);</span>

  <span class="kt">double</span> <span class="n">x</span> <span class="o">=</span> <span class="n">xyz_trans</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xyz_trans</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">z</span> <span class="o">=</span> <span class="n">xyz_trans</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="kt">double</span> <span class="n">z_2</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">;</span>

  <span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="o">&gt;</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="n">tmp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">fx</span><span class="p">;</span>
  <span class="n">tmp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">tmp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="o">/</span><span class="n">z</span><span class="o">*</span><span class="n">fx</span><span class="p">;</span>

  <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">fy</span><span class="p">;</span>
  <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">y</span><span class="o">/</span><span class="n">z</span><span class="o">*</span><span class="n">fy</span><span class="p">;</span>

  <span class="n">_jacobianOplusXi</span> <span class="o">=</span>  <span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span> <span class="n">tmp</span> <span class="o">*</span> <span class="n">T</span><span class="p">.</span><span class="n">rotation</span><span class="p">().</span><span class="n">toRotationMatrix</span><span class="p">();</span>

  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span>  <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="n">z_2</span> <span class="o">*</span><span class="n">fx</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="n">z_2</span><span class="p">))</span> <span class="o">*</span><span class="n">fx</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span><span class="n">fx</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span><span class="n">fx</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span><span class="o">/</span><span class="n">z_2</span> <span class="o">*</span><span class="n">fx</span><span class="p">;</span>

  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="n">z_2</span><span class="p">)</span> <span class="o">*</span><span class="n">fy</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="n">z_2</span> <span class="o">*</span><span class="n">fy</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span><span class="n">fy</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span><span class="n">fy</span><span class="p">;</span>
  <span class="n">_jacobianOplusXj</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span><span class="o">/</span><span class="n">z_2</span> <span class="o">*</span><span class="n">fy</span><span class="p">;</span>
<span class="p">}</span> <span class="c1">// é‡æŠ•å½±è¯¯å·®çš„é›…å…‹æ¯”çŸ©é˜µï¼ˆBA ä¼˜åŒ–æ—¶ç›¸å¯¹äºç›¸æœºä½å§¿å’Œåœ°å›¾ç‚¹çš„ä¸€é˜¶å¯¼ï¼‰
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h3 id="43-é—­ç¯æ£€æµ‹æ—¶çš„é‡æŠ•å½±è¯¯å·®">4.3 é—­ç¯æ£€æµ‹æ—¶çš„é‡æŠ•å½±è¯¯å·®</h3>
<ul>
<li>é—­ç¯æ£€æµ‹æ—¶æ‰§è¡Œ <strong>sim3 ä¼˜åŒ–</strong>ï¼Œè¾¹æ˜¯é‡æŠ•å½±è¯¯å·®ï¼Œ<strong>é¡¶ç‚¹æ˜¯ sim3 è¡¨ç¤ºçš„ç›¸æœºä½å§¿å’Œåœ°å›¾ç‚¹åæ ‡</strong>ï¼Œå¯¹åº” g2o/types/types_seven_dof_expmap.h ä¸­å®šä¹‰çš„è¾¹æŠ•å½±åˆ°å½“å‰å¸§ <strong>EdgeSim3ProjectXYZ</strong> å’Œ  æŠ•å½±åˆ°é—­ç¯å¸§ <strong>EdgeInverseSim3ProjectXYZ</strong>ã€‚
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// BRIEF è¾¹ï¼šé‡æŠ•å½±è¯¯å·®ï¼ˆé—­ç¯æ£€æµ‹æ—¶ï¼‰é¡¶ç‚¹ï¼šåœ°å›¾ç‚¹åæ ‡ï¼Œsim3 è¡¨ç¤ºçš„ç›¸æœºä½å§¿.
</span><span class="c1"></span><span class="k">class</span> <span class="nc">EdgeSim3ProjectXYZ</span> <span class="o">:</span> <span class="k">public</span>  <span class="n">BaseBinaryEdge</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="n">Vector2d</span><span class="p">,</span>  <span class="n">VertexSBAPointXYZ</span><span class="p">,</span> <span class="n">VertexSim3Expmap</span><span class="o">&gt;</span>
<span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>

    <span class="n">EdgeSim3ProjectXYZ</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

    <span class="c1">// é‡æŠ•å½±è¯¯å·®è®¡ç®—.
</span><span class="c1"></span>    <span class="kt">void</span> <span class="nf">computeError</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="k">const</span> <span class="n">VertexSim3Expmap</span><span class="o">*</span> <span class="n">v1</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">VertexSim3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="k">const</span> <span class="n">VertexSBAPointXYZ</span><span class="o">*</span> <span class="n">v2</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">VertexSBAPointXYZ</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

      <span class="n">Vector2d</span> <span class="n">obs</span><span class="p">(</span><span class="n">_measurement</span><span class="p">);</span>
      <span class="n">_error</span> <span class="o">=</span> <span class="n">obs</span><span class="o">-</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">cam_map1</span><span class="p">(</span><span class="n">project</span><span class="p">(</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">v2</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">())));</span>
    <span class="p">}</span>

    <span class="c1">// TODO è¿™é‡Œç»§æ‰¿çš„ BaseBinaryEdge é›…å…‹æ¯”çŸ©é˜µæ„é€ å‡½æ•°ï¼Ÿ.
</span><span class="c1"></span>    <span class="c1">// virtual void linearizeOplus();
</span><span class="c1"></span><span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="44-sim3-ä¹‹é—´çš„ç›¸å¯¹è¯¯å·®">4.4 Sim3 ä¹‹é—´çš„ç›¸å¯¹è¯¯å·®</h3>
<ul>
<li>OptimizeEssentialGraph ä¼šåœ¨æˆåŠŸè¿›è¡Œé—­ç¯æ£€æµ‹åã€å…¨å±€ BA ä¼˜åŒ–å‰è¿›è¡Œï¼Œ<strong>è¾¹ä¸º Sim3 ä¹‹é—´çš„ç›¸å¯¹è¯¯å·®ï¼Œé¡¶ç‚¹ä¸º Sim3 è¡¨ç¤ºçš„ç›¸æœºä½å§¿</strong>ã€‚å¯¹åº” g2o/types/types_seven_dof_expmap.h ä¸­å®šä¹‰çš„è¾¹ <strong>EdgeSim3</strong>ã€‚
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// BRIEF è¾¹ï¼šSim3 ä¹‹é—´çš„ç›¸å¯¹è¯¯å·®ï¼Œé¡¶ç‚¹ï¼šSim3 è¡¨ç¤ºçš„ poseã€‚ï¼ˆOptimizeEssentialGraph ä¼˜åŒ–ä¸­ï¼‰
</span><span class="c1"></span>  <span class="k">class</span> <span class="nc">EdgeSim3</span> <span class="o">:</span> <span class="k">public</span> <span class="n">BaseBinaryEdge</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">,</span> <span class="n">Sim3</span><span class="p">,</span> <span class="n">VertexSim3Expmap</span><span class="p">,</span> <span class="n">VertexSim3Expmap</span><span class="o">&gt;</span>
  <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">EIGEN_MAKE_ALIGNED_OPERATOR_NEW</span>

    <span class="n">EdgeSim3</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">read</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">write</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

    <span class="c1">// è¯¯å·®è®¡ç®—.
</span><span class="c1"></span>    <span class="kt">void</span> <span class="nf">computeError</span><span class="p">()</span>
    <span class="p">{</span>
      <span class="k">const</span> <span class="n">VertexSim3Expmap</span><span class="o">*</span> <span class="n">v1</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">VertexSim3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="k">const</span> <span class="n">VertexSim3Expmap</span><span class="o">*</span> <span class="n">v2</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">VertexSim3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

      <span class="n">Sim3</span> <span class="n">C</span><span class="p">(</span><span class="n">_measurement</span><span class="p">);</span>
      <span class="n">Sim3</span> <span class="n">error_</span><span class="o">=</span><span class="n">C</span><span class="o">*</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">()</span><span class="o">*</span><span class="n">v2</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">().</span><span class="n">inverse</span><span class="p">();</span>
      <span class="n">_error</span> <span class="o">=</span> <span class="n">error_</span><span class="p">.</span><span class="n">log</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">virtual</span> <span class="kt">double</span> <span class="nf">initialEstimatePossible</span><span class="p">(</span><span class="k">const</span> <span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">VertexSet</span><span class="o">&amp;</span> <span class="p">,</span> <span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*</span> <span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mf">1.</span><span class="p">;}</span>

    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">initialEstimate</span><span class="p">(</span><span class="k">const</span> <span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">VertexSet</span><span class="o">&amp;</span> <span class="n">from</span><span class="p">,</span> <span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*</span> <span class="cm">/*to*/</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">VertexSim3Expmap</span><span class="o">*</span> <span class="n">v1</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">VertexSim3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="n">VertexSim3Expmap</span><span class="o">*</span> <span class="n">v2</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">VertexSim3Expmap</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">_vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">from</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">v2</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">measurement</span><span class="p">()</span><span class="o">*</span><span class="n">v1</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">());</span>
      <span class="k">else</span>
        <span class="n">v1</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">measurement</span><span class="p">().</span><span class="n">inverse</span><span class="p">()</span><span class="o">*</span><span class="n">v2</span><span class="o">-&gt;</span><span class="n">estimate</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">};</span> <span class="c1">// è¾¹ï¼šSim3 ä¹‹é—´çš„ç›¸å¯¹è¯¯å·®ï¼Œé¡¶ç‚¹ï¼šSim3 è¡¨ç¤ºçš„ poseã€‚ï¼ˆOptimizeEssentialGraph ä¼˜åŒ–ä¸­ï¼‰
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<hr>
<h2 id="5-orb-slam2-ä¸­çš„ä¼˜åŒ–å‡½æ•°">5. ORB-SLAM2 ä¸­çš„ä¼˜åŒ–å‡½æ•°</h2>
<h3 id="51-ä½å§¿ä¼˜åŒ–å‡½æ•°-poseoptimization">5.1 ä½å§¿ä¼˜åŒ–å‡½æ•° PoseOptimization()</h3>
<ul>
<li><strong>å‡½æ•°æè¿°ï¼š</strong>
<ul>
<li>åœ¨ Tracking çº¿ç¨‹ä¸­è¿›è¡Œä½å§¿ä¼˜åŒ–çš„æ—¶å€™ï¼Œæ¯è¿›è¡Œè¿‡ä¸€æ¬¡ <strong>PnP æŠ•å½±æ“ä½œå°†åœ°å›¾ç‚¹æŠ•å½±åˆ°å½“å‰å¹³é¢ä¸Šä¹‹å</strong>ï¼Œéƒ½ä¼šè¿›è¡Œä¸€æ¬¡PoseOptimization ä½å§¿ä¼˜åŒ–æœ€å°åŒ–é‡æŠ•å½±è¯¯å·®ï¼›</li>
<li>3D-2D <strong>æœ€å°åŒ–é‡æŠ•å½±è¯¯å·®</strong> e = (u,v) - project(Tcw*Pw)ï¼›</li>
<li><strong>åªä¼˜åŒ–å½“å‰å¸§ poseï¼Œåœ°å›¾ç‚¹å›ºå®š</strong>ï¼›</li>
<li>ç”¨äº LocalTracking ä¸­è¿åŠ¨æ¨¡å‹è·Ÿè¸ªï¼Œå‚è€ƒå¸§è·Ÿè¸ªï¼Œåœ°å›¾è·Ÿè¸ª TrackLocalMapï¼Œé‡å®šä½ã€‚</li>
</ul>
</li>
<li><strong>é¡¶ç‚¹å’Œè¾¹ï¼š</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="mf">1.</span> <span class="nl">Vertex</span><span class="p">:</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="p">()</span><span class="err">ï¼Œå³å½“å‰å¸§çš„</span> <span class="n">Tcw</span>
<span class="mf">2.</span> <span class="nl">Edge</span><span class="p">:</span> <span class="err">é‡æŠ•å½±è¯¯å·®ï¼ˆä¸€å…ƒè¾¹ï¼‰</span>
 <span class="o">-</span> <span class="err">å•ç›®æƒ…å†µï¼š</span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSE3ProjectXYZOnlyPose</span><span class="p">()</span><span class="err">ï¼Œ</span><span class="n">BaseUnaryEdge</span>
     <span class="o">+</span> <span class="n">Vertex</span><span class="err">ï¼šå¾…ä¼˜åŒ–å½“å‰å¸§çš„</span><span class="n">Tcw</span>
     <span class="o">+</span> <span class="n">measurement</span><span class="err">ï¼š</span><span class="n">MapPointåœ¨å½“å‰å¸§ä¸­çš„äºŒç»´ä½ç½®</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
     <span class="o">+</span> <span class="nl">InfoMatrix</span><span class="p">:</span> <span class="n">invSigma2</span><span class="p">(</span><span class="err">ä¸ç‰¹å¾ç‚¹æ‰€åœ¨çš„å°ºåº¦æœ‰å…³</span><span class="p">)</span>
 <span class="o">-</span> <span class="err">åŒç›®æƒ…å†µï¼š</span><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeStereoSE3ProjectXYZOnlyPose</span><span class="p">()</span><span class="err">ï¼Œ</span><span class="n">BaseUnaryEdge</span>
     <span class="o">+</span> <span class="n">Vertex</span><span class="err">ï¼šå¾…ä¼˜åŒ–å½“å‰å¸§çš„</span><span class="n">Tcw</span>
     <span class="o">+</span> <span class="n">measurement</span><span class="err">ï¼š</span><span class="n">MapPointåœ¨å½“å‰å¸§ä¸­çš„äºŒç»´ä½ç½®</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">ur</span><span class="p">)</span>
     <span class="o">+</span> <span class="nl">InfoMatrix</span><span class="p">:</span> <span class="n">invSigma2</span><span class="p">(</span><span class="err">ä¸ç‰¹å¾ç‚¹æ‰€åœ¨çš„å°ºåº¦æœ‰å…³</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>å‡½æ•°æ‰§è¡Œæµç¨‹ï¼š</strong>
<ul>
<li><strong>æ­¥éª¤ä¸€ï¼š</strong> æ„é€  g2o <strong>ä¼˜åŒ–å™¨</strong></li>
<li><strong>æ­¥éª¤äºŒï¼š</strong> å‘ä¼˜åŒ–å™¨ä¸­<strong>æ·»åŠ é¡¶ç‚¹</strong>-å½“å‰å¸§çš„ä½å§¿</li>
<li><strong>æ­¥éª¤ä¸‰ï¼š</strong> å‘ä¼˜åŒ–å™¨ä¸­<strong>æ·»åŠ è¾¹</strong>ï¼ˆä»¥å•ç›®<strong>é‡æŠ•å½±è¯¯å·®</strong>ä¸ºä¾‹ï¼‰
<ul>
<li><strong>æ­¥éª¤ 1ï¼š</strong> å®ä¾‹åŒ–ä¸€ä¸ª EdgeSE3ProjectXYZOnlyPose ä¸€å…ƒè¾¹
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSE3ProjectXYZOnlyPose</span><span class="o">*</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSE3ProjectXYZOnlyPose</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>æ­¥éª¤ 2ï¼š</strong> è®¾ç½®è¾¹è¿æ¥çš„é¡¶ç‚¹
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">e</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="mi">0</span><span class="p">)));</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>æ­¥éª¤ 3ï¼š</strong> æ·»åŠ è¾¹çš„è§‚æµ‹å€¼ï¼ˆ2Dï¼‰
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">e</span><span class="o">-&gt;</span><span class="n">setMeasurement</span><span class="p">(</span><span class="n">obs</span><span class="p">);</span>     <span class="c1">// è§‚æµ‹ï¼šåœ°å›¾ç‚¹åœ¨å½“å‰å¸§ä¸­çš„åƒç´ åæ ‡.
</span></code></pre></td></tr></table>
</div>
</div></li>
<li><strong>æ­¥éª¤ 4ï¼š</strong> è®¾ç½®è¾¹çš„ä¿¡æ¯çŸ©é˜µ
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">const</span> <span class="kt">float</span> <span class="n">invSigma2</span> <span class="o">=</span> <span class="n">pFrame</span><span class="o">-&gt;</span><span class="n">mvInvLevelSigma2</span><span class="p">[</span><span class="n">kpUn</span><span class="p">.</span><span class="n">octave</span><span class="p">];</span>
<span class="c1">// note è®¾ç½®æƒé‡ï¼ˆä¿¡æ¯çŸ©é˜µï¼‰ï¼Œä¸ç‰¹å¾ç‚¹é‡‘å­—å¡”æœ‰å…³ï¼Œå‚è€ƒï¼šhttps://www.zhihu.com/question/58762862
</span><span class="c1"></span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setInformation</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix2d</span><span class="o">::</span><span class="n">Identity</span><span class="p">()</span><span class="o">*</span><span class="n">invSigma2</span><span class="p">);</span>   <span class="c1">// ä¿¡æ¯çŸ©é˜µï¼ˆæƒé‡ï¼‰
</span></code></pre></td></tr></table>
</div>
</div></li>
<li><strong>æ­¥éª¤ 5ï¼š</strong> è®¾ç½®æ ¸å‡½æ•°</li>
<li><strong>æ­¥éª¤ 6ï¼š</strong> è·å–åœ°å›¾ç‚¹çš„ä¸–ç•Œåæ ‡ï¼ˆ3Dï¼‰
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">Xw</span> <span class="o">=</span> <span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetWorldPos</span><span class="p">();</span>
<span class="n">e</span><span class="o">-&gt;</span><span class="n">Xw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xw</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">e</span><span class="o">-&gt;</span><span class="n">Xw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xw</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">e</span><span class="o">-&gt;</span><span class="n">Xw</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xw</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>æ­¥éª¤ 7ï¼š</strong> å°†è¾¹æ·»åŠ åˆ°ä¼˜åŒ–å™¨ä¸­ã€‚</li>
</ul>
</li>
<li><strong>æ­¥éª¤å››ï¼šå¼€å§‹ä¼˜åŒ–ï¼Œå…±ä¼˜åŒ– 4 æ¬¡</strong>ï¼Œæ¯æ¬¡ä¼˜åŒ–åå°†è§‚æµ‹åˆ†ä¸º outlier å’Œ inlierï¼Œoutlier ä¸å‚ä¸ä¸‹æ¬¡ä¼˜åŒ–ã€‚
<ul>
<li>ä½†ç”±äºæ¯æ¬¡ä¼˜åŒ–åæ˜¯å¯¹æ‰€æœ‰çš„è§‚æµ‹è¿›è¡Œoutlierå’Œinlieråˆ¤åˆ«ï¼Œå› æ­¤ä¹‹å‰è¢«åˆ¤åˆ«ä¸ºoutlieræœ‰å¯èƒ½å˜æˆinlierï¼Œåä¹‹äº¦ç„¶ã€‚</li>
<li>åŸºäº<strong>å¡æ–¹æ£€éªŒ</strong>è®¡ç®—å¼‚å¸¸å€¼çš„é˜ˆå€¼ï¼ˆå‡è®¾æµ‹é‡æœ‰ä¸€ä¸ªåƒç´ çš„åå·®ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>æ­¥éª¤äº”ï¼š</strong> ä¼˜åŒ–ç»“æŸï¼Œç”¨ä¼˜åŒ–ä¹‹åçš„ä½å§¿æ›´æ–°å½“å‰å¸§çš„ä½å§¿ã€‚</li>
</ul>
</li>
</ul>
<h3 id="52-å±€éƒ¨ä¼˜åŒ–-localbundleadjustment">5.2 å±€éƒ¨ä¼˜åŒ– LocalBundleAdjustment()</h3>
<ul>
<li><strong>å‡½æ•°æè¿°</strong>
<ul>
<li>æ‰§è¡Œæ¡ä»¶ï¼šåœ¨<strong>å·²ç»å¤„ç†å®Œé˜Ÿåˆ—ä¸­çš„æœ€åä¸€ä¸ªå…³é”®å¸§ä¹‹å</strong>ï¼Œå¹¶ä¸”é—­ç¯æ£€æµ‹çº¿ç¨‹æ²¡æœ‰è¯·æ±‚åœæ­¢å±€éƒ¨å»ºå›¾çº¿ç¨‹ï¼Œåˆ™å¼€å§‹<strong>å¯¹å½“å‰å¸§è¿›è¡Œå±€éƒ¨ BA ä¼˜åŒ–</strong>ï¼Œæˆ–è€…å½“æ–°çš„å…³é”®å¸§åŠ å…¥åˆ° convisibility graph æ—¶ï¼Œ<strong>åœ¨å…³é”®å¸§é™„è¿‘è¿›è¡Œä¸€æ¬¡å±€éƒ¨ä¼˜åŒ–</strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼›
<!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted -->
<ul>
<li>Pos3 æ˜¯æ–°åŠ å…¥çš„å…³é”®å¸§ï¼Œå…¶åˆå§‹ä¼°è®¡ä½å§¿å·²ç»å¾—åˆ°ï¼Œæ­¤æ—¶ï¼ŒPos2 æ˜¯å’Œ Pos3 ç›¸è¿çš„å…³é”®å¸§ï¼ŒX2 æ˜¯ Pos3 çœ‹åˆ°çš„ä¸‰ç»´ç‚¹ï¼ŒX1 æ˜¯ Pos2 çœ‹åˆ°çš„ä¸‰ç»´ç‚¹ï¼Œè¿™äº›éƒ½å±äºå±€éƒ¨ä¿¡æ¯ï¼Œ<strong>å…±åŒå‚ä¸Bundle Adjustment</strong>ï¼ˆåœˆå†…çº¢è‰²éƒ¨åˆ†ï¼‰ï¼›</li>
<li>åŒæ—¶ï¼ŒPos1 ä¹Ÿå¯ä»¥çœ‹åˆ° X1ï¼Œä½†å®ƒå’Œ Pos3 æ²¡æœ‰ç›´æ¥çš„è”ç³»ï¼Œå±äº Pos3 å…³è”çš„å±€éƒ¨ä¿¡æ¯ï¼Œ<strong>å‚ä¸ Bundle Adjustmentï¼Œä½†å–å€¼ä¿æŒä¸å˜</strong>ï¼ˆåœˆå†…ç°è‰²éƒ¨åˆ†ï¼‰ï¼›</li>
<li>Pos0 å’Œ X0 <strong>ä¸å‚ä¸ Bundle Adjustment</strong>ï¼ˆåœˆå¤–ç°è‰²éƒ¨åˆ†ï¼‰ã€‚</li>
<li>å› æ­¤ï¼Œå‚ä¸ä¼˜åŒ–çš„æ˜¯ä¸Šå›¾ä¸­çº¢è‰²æ¤­åœ†åœˆå‡ºçš„éƒ¨åˆ†ï¼Œå…¶ä¸­çº¢è‰²ä»£è¡¨å–å€¼ä¼šè¢«ä¼˜åŒ–ï¼Œç°è‰²ä»£è¡¨å–å€¼ä¿æŒä¸å˜ã€‚(u,v) æ˜¯ X åœ¨ Pos ä¸‹çš„äºŒç»´æŠ•å½±ç‚¹ï¼Œå³ X åœ¨ Pos ä¸‹çš„æµ‹é‡ï¼ˆmeasurementï¼‰ï¼Œ<strong>ä¼˜åŒ–çš„ç›®æ ‡æ˜¯è®©æŠ•å½±è¯¯å·®æœ€å°</strong>ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>é¡¶ç‚¹ä¸è¾¹</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="mf">1.</span> <span class="nl">Vertex</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="p">()</span><span class="err">ï¼Œ</span><span class="n">LocalKeyFrames</span><span class="err">ï¼Œå³å½“å‰å…³é”®å¸§ä¸€çº§ä¸å½“å‰å…³é”®å¸§ç›¸è¿çš„å…³é”®å¸§çš„ä½å§¿</span>
    <span class="o">-</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="p">()</span><span class="err">ï¼Œ</span><span class="n">FixedCameras</span><span class="err">ï¼Œå³èƒ½è§‚æµ‹åˆ°</span><span class="n">LocalMapPointsçš„å…³é”®å¸§</span><span class="err">ï¼ˆå¹¶ä¸”ä¸å±äº</span><span class="n">LocalKeyFrames</span><span class="err">ï¼‰çš„ä½å§¿ï¼Œåœ¨ä¼˜åŒ–ä¸­è¿™äº›å…³é”®å¸§çš„ä½å§¿ä¸å˜</span>
    <span class="o">-</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="p">()</span><span class="err">ï¼Œ</span><span class="n">LocalMapPoints</span><span class="err">ï¼Œå³</span><span class="n">LocalKeyFramesèƒ½è§‚æµ‹åˆ°çš„æ‰€æœ‰MapPointsçš„ä½ç½®</span>
<span class="mf">2.</span> <span class="nl">Edge</span><span class="p">:</span>
    <span class="o">-</span> <span class="err">å•ç›®</span> <span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSE3ProjectXYZ</span><span class="p">()</span><span class="err">ï¼Œ</span><span class="n">BaseBinaryEdge</span>
        <span class="o">+</span> <span class="n">Vertex</span><span class="err">ï¼šå…³é”®å¸§çš„</span><span class="n">Tcw</span><span class="err">ï¼Œ</span><span class="n">MapPointçš„Pw</span>
        <span class="o">+</span> <span class="n">measurement</span><span class="err">ï¼š</span><span class="n">MapPointåœ¨å…³é”®å¸§ä¸­çš„äºŒç»´ä½ç½®</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="nl">InfoMatrix</span><span class="p">:</span> <span class="n">invSigma2</span><span class="p">(</span><span class="err">ä¸ç‰¹å¾ç‚¹æ‰€åœ¨çš„å°ºåº¦æœ‰å…³</span><span class="p">)</span>
    <span class="o">-</span> <span class="err">åŒç›®</span> <span class="n">g2o</span><span class="o">::</span><span class="n">EdgeStereoSE3ProjectXYZ</span><span class="p">()</span><span class="err">ï¼Œ</span><span class="n">BaseBinaryEdge</span>
        <span class="o">+</span> <span class="n">Vertex</span><span class="err">ï¼šå…³é”®å¸§çš„</span><span class="n">Tcw</span><span class="err">ï¼Œ</span><span class="n">MapPointçš„Pw</span>
        <span class="o">+</span> <span class="n">measurement</span><span class="err">ï¼š</span><span class="n">MapPointåœ¨å…³é”®å¸§ä¸­çš„äºŒç»´ä½ç½®</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">ur</span><span class="p">)</span>
        <span class="o">+</span> <span class="nl">InfoMatrix</span><span class="p">:</span> <span class="n">invSigma2</span><span class="p">(</span><span class="err">ä¸ç‰¹å¾ç‚¹æ‰€åœ¨çš„å°ºåº¦æœ‰å…³</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>å‡½æ•°æ‰§è¡Œæµç¨‹</strong>
<ul>
<li><strong>æ­¥éª¤ä¸€ï¼šæ„é€ å±€éƒ¨å…³é”®å¸§åˆ—è¡¨</strong>
<ul>
<li>æ­¥éª¤ 1ï¼šå°†<strong>å½“å‰å¸§</strong>åŠ å…¥åˆ°åˆ—è¡¨ä¸­
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">list</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span> <span class="n">lLocalKeyFrames</span><span class="p">;</span>
<span class="n">lLocalKeyFrames</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pKF</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>æ­¥éª¤ 2ï¼šå°†<strong>ä¸å½“å‰å…³é”®å¸§ä¸€çº§ç›¸è¿</strong>çš„å…³é”®å¸§åŠ å…¥åˆ°åˆ—è¡¨ä¸­
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">const</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">KeyFrame</span><span class="o">*&gt;</span> <span class="n">vNeighKFs</span> <span class="o">=</span> <span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetVectorCovisibleKeyFrames</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
<li><strong>æ­¥éª¤äºŒï¼šæ„é€ å±€éƒ¨åœ°å›¾ç‚¹åˆ—è¡¨</strong>ã€‚éå†å‰é¢çš„å±€éƒ¨å…³é”®å¸§åˆ—è¡¨ lLocalKeyFramesï¼Œå¾—åˆ°æ¯ä¸ªå…³é”®å¸§é”è§‚æµ‹åˆ°çš„åœ°å›¾ç‚¹ï¼ŒåŠ å…¥åˆ°å±€éƒ¨åœ°å›¾ç‚¹åˆ—è¡¨ lLocalMapPoints ä¸­ã€‚</li>
<li><strong>æ­¥éª¤ä¸‰ï¼šæ„é€ èƒ½è¢«å±€éƒ¨åœ°å›¾ç‚¹è§‚æµ‹åˆ°çš„ä½†ä¸å±äºå±€éƒ¨å…³é”®å¸§åˆ—è¡¨çš„å…³é”®å¸§</strong> lFixedCameras ã€‚è¿™äº›å…³é”®å¸§å‚ä¸å±€éƒ¨ BA ä½†ä¸æ”¹å˜å…¶å€¼ã€‚</li>
<li><strong>æ­¥éª¤å››ï¼šæ„é€  g2o ä¼˜åŒ–å™¨</strong></li>
<li><strong>æ­¥éª¤äº”ï¼šå‘ä¼˜åŒ–å™¨ä¸­æ·»åŠ é¡¶ç‚¹ VertexSE3Expmap - å±€éƒ¨å…³é”®å¸§</strong>ã€‚éå†å±€éƒ¨å…³é”®å¸§åºåˆ— lLocalKeyFramesï¼Œå°†å…¶åˆ›å»ºä¸ºé¡¶ç‚¹ï¼Œæ·»åŠ åˆ°ä¼˜åŒ–å™¨ä¸­
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// å®ä¾‹åŒ–ä¸€ä¸ª VertexSE3Expmap é¡¶ç‚¹çš„å¯¹è±¡.
</span><span class="c1"></span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span> <span class="o">*</span> <span class="n">vSE3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="p">();</span>
      
<span class="c1">// è®¾ç½®é¡¶ç‚¹çš„å…³é”®å¸§ä½å§¿å±æ€§ï¼ˆSE3 å½¢å¼ï¼‰ã€ID å’Œå›ºå®šçš„é¡¶ç‚¹.
</span><span class="c1"></span><span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toSE3Quat</span><span class="p">(</span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">GetPose</span><span class="p">()));</span>
<span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">);</span>
<span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setFixed</span><span class="p">(</span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span> <span class="c1">//ç¬¬ä¸€å¸§ä½ç½®å›ºå®š
</span><span class="c1"></span>      
<span class="c1">// å°†é¡¶ç‚¹æ·»åŠ åˆ°çš„ä¼˜åŒ–å™¨ä¸­.
</span><span class="c1"></span><span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span><span class="p">(</span><span class="n">vSE3</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>æ­¥éª¤å…­ï¼šå‘ä¼˜åŒ–å™¨ä¸­æ·»åŠ é¡¶ç‚¹ VertexSE3Expmap - ä¸ä¿®æ”¹å€¼çš„å…³é”®å¸§</strong>ã€‚éå†å‰é¢æ„é€ çš„ lFixedCamerasï¼Œåˆ†åˆ«å¯¹é½åˆ›å»ºä¸ºé¡¶ç‚¹ï¼Œæ³¨æ„ setFixed(true) ä¸æ”¹å˜å…¶å€¼
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span> <span class="o">*</span> <span class="n">vSE3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="p">();</span>
<span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toSE3Quat</span><span class="p">(</span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">GetPose</span><span class="p">()));</span>
<span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">);</span>
<span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setFixed</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span><span class="p">(</span><span class="n">vSE3</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>æ­¥éª¤ä¸ƒï¼šå‘ä¼˜åŒ–å™¨ä¸­æ·»åŠ é¡¶ç‚¹ VertexSBAPointXYZ - åœ°å›¾ç‚¹</strong>ã€‚éå†å‰é¢çš„å±€éƒ¨åœ°å›¾ç‚¹åˆ—è¡¨ï¼Œä¾æ¬¡åˆ›å»ºé¡¶ç‚¹
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// å®ä¾‹åŒ–ä¸€ä¸ª VertexSBAPointXYZ é¡¶ç‚¹.
</span><span class="c1"></span><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="o">*</span> <span class="n">vPoint</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="p">();</span>
<span class="c1">// è®¾ç½®é¡¶ç‚¹çš„ä½ç½®ã€IDï¼Œè¾¹ç¼˜åŒ–.
</span><span class="c1"></span><span class="n">vPoint</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toVector3d</span><span class="p">(</span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetWorldPos</span><span class="p">()));</span>
<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">pMP</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="o">+</span><span class="n">maxKFid</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="n">vPoint</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="n">vPoint</span><span class="o">-&gt;</span><span class="n">setMarginalized</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="c1">// å°†é¡¶ç‚¹æ·»åŠ åˆ°ä¼˜åŒ–å™¨ä¸­.
</span><span class="c1"></span><span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span><span class="p">(</span><span class="n">vPoint</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>æ­¥éª¤å…«ï¼šä¸ºæ¯ä¸€å¯¹å…³è”çš„åœ°å›¾ç‚¹å’Œå…³é”®å¸§åˆ›å»ºè¾¹</strong>ï¼ˆä¸ä¸Šä¸€æ­¥æ„å»ºåœ°å›¾ç‚¹é¡¶ç‚¹ä¸€èµ·åˆ›å»ºï¼Œä»¥å•ç›®ä¸ºä¾‹ï¼‰ã€‚
<ul>
<li>æ­¥éª¤ 1ï¼šå®ä¾‹åŒ–ä¸€æ¡äºŒå…ƒè¾¹ EdgeSE3ProjectXYZ
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSE3ProjectXYZ</span><span class="o">*</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSE3ProjectXYZ</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>æ­¥éª¤ 2ï¼šä¸ºè¾¹æ·»åŠ å…³è”çš„é¡¶ç‚¹
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">e</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">id</span><span class="p">)));</span><span class="c1">// åœ°å›¾ç‚¹ ID.
</span><span class="c1"></span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">)));</span><span class="c1">// å…³é”®å¸§ ID.
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>æ­¥éª¤ 3ï¼šæ·»åŠ æµ‹é‡å€¼
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">e</span><span class="o">-&gt;</span><span class="n">setMeasurement</span><span class="p">(</span><span class="n">obs</span><span class="p">);</span>     <span class="c1">// æµ‹é‡ï¼šåœ°å›¾ç‚¹åœ¨å½“å‰å¸§ä¸­çš„äºŒç»´ä½ç½®.
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>æ­¥éª¤ 4ï¼šæ„é€ ä¿¡æ¯çŸ©é˜µ
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">const</span> <span class="kt">float</span> <span class="o">&amp;</span><span class="n">invSigma2</span> <span class="o">=</span> <span class="n">pKFi</span><span class="o">-&gt;</span><span class="n">mvInvLevelSigma2</span><span class="p">[</span><span class="n">kpUn</span><span class="p">.</span><span class="n">octave</span><span class="p">];</span> <span class="c1">// ä¸ç‰¹å¾ç‚¹æ‰€åœ¨çš„å°ºåº¦æœ‰å…³.
</span><span class="c1"></span><span class="n">e</span><span class="o">-&gt;</span><span class="n">setInformation</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix2d</span><span class="o">::</span><span class="n">Identity</span><span class="p">()</span><span class="o">*</span><span class="n">invSigma2</span><span class="p">);</span>   <span class="c1">// è®¾ç½®ä¿¡æ¯çŸ©é˜µ.
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>æ­¥éª¤ 5ï¼šè®¾ç½®æ ¸å‡½æ•°</li>
<li>æ­¥éª¤ 6ï¼šå°†è¾¹æ·»åŠ åˆ°ä¼˜åŒ–å™¨ä¸­</li>
</ul>
</li>
<li><strong>æ­¥éª¤ä¹ï¼šå¼€å§‹æ‰§è¡Œä¼˜åŒ–ï¼Œè¿­ä»£ 5 æ¬¡</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">optimizer</span><span class="p">.</span><span class="n">initializeOptimization</span><span class="p">();</span>
<span class="n">optimizer</span><span class="p">.</span><span class="n">optimize</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>      <span class="c1">// è¿­ä»£ 5 æ¬¡.
</span></code></pre></td></tr></table>
</div>
</div></li>
<li><strong>æ­¥éª¤åï¼šæ£€æµ‹ outlier</strong>ï¼Œå¹¶è®¾ç½®ä¸‹æ¬¡ä¸ä¼˜åŒ–ï¼ŒåŒå‰é¢ä½å§¿ä¼˜åŒ–æ—¶ä¸€æ ·é‡‡ç”¨å¡æ–¹æ£€éªŒè®¡ç®—é˜ˆå€¼ã€‚</li>
<li><strong>æ­¥éª¤åä¸€ï¼šæ’é™¤è¯¯å·®è¾ƒå¤§çš„ outlier åå†æ¬¡ä¼˜åŒ–</strong>ï¼Œè¿­ä»£ 10 æ¬¡
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">optimizer</span><span class="p">.</span><span class="n">initializeOptimization</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">optimizer</span><span class="p">.</span><span class="n">optimize</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>æ­¥éª¤åäºŒï¼šåœ¨ä¼˜åŒ–åé‡æ–°è®¡ç®—è¯¯å·®ï¼Œå‰”é™¤è¿æ¥è¯¯å·®æ¯”è¾ƒå¤§çš„å…³é”®å¸§å’Œåœ°å›¾ç‚¹</strong>ã€‚</li>
<li><strong>æ­¥éª¤åä¸‰ï¼šä¼˜åŒ–åæ›´æ–°å…³é”®å¸§ä½å§¿ä»¥åŠåœ°å›¾ç‚¹åæ ‡ã€å¹³å‡è§‚æµ‹æ–¹å‘ç­‰å±æ€§</strong>ã€‚</li>
</ul>
</li>
</ul>
<h3 id="53-å…¨å±€ä¼˜åŒ–-globalbundleadjustemnt">5.3 å…¨å±€ä¼˜åŒ– GlobalBundleAdjustemnt()</h3>
<ul>
<li><strong>å‡½æ•°æè¿°</strong>
<ul>
<li>å…¨å±€ BA ä¼˜åŒ–åœ¨<strong>å•ç›®åˆå§‹åŒ–å’Œé—­ç¯çŸ«æ­£æ—¶æ‰§è¡Œ</strong>ã€‚åœ¨å…¨å±€ä¼˜åŒ–ä¸­ï¼Œ<strong>æ‰€æœ‰çš„å…³é”®å¸§ï¼ˆé™¤äº†ç¬¬ä¸€å¸§ï¼‰å’Œä¸‰ç»´ç‚¹éƒ½å‚ä¸ä¼˜åŒ–</strong>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li><strong>é¡¶ç‚¹ä¸è¾¹</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="mi">3</span><span class="n">D</span><span class="o">-</span><span class="mi">2</span><span class="n">D</span> <span class="err">æœ€å°åŒ–é‡æŠ•å½±è¯¯å·®</span> <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="o">-</span> <span class="n">project</span><span class="p">(</span><span class="n">Tcw</span><span class="o">*</span><span class="n">Pw</span><span class="p">)</span>
<span class="mf">1.</span> <span class="nl">Vertex</span><span class="p">:</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="p">()</span><span class="err">ï¼Œå³å½“å‰å¸§çš„</span><span class="n">Tcw</span>
           <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="p">()</span><span class="err">ï¼Œ</span><span class="n">MapPoint</span> <span class="err">çš„</span> <span class="n">mWorldPos</span>
<span class="mf">2.</span> <span class="nl">Edge</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSE3ProjectXYZ</span><span class="p">()</span><span class="err">ï¼Œ</span><span class="n">BaseBinaryEdge</span>
        <span class="o">+</span> <span class="n">Vertex</span><span class="err">ï¼šå¾…ä¼˜åŒ–å½“å‰å¸§çš„</span><span class="n">Tcw</span>
        <span class="o">+</span> <span class="n">Vertex</span><span class="err">ï¼šå¾…ä¼˜åŒ–</span><span class="n">MapPointçš„mWorldPos</span>
        <span class="o">+</span> <span class="n">measurement</span><span class="err">ï¼š</span><span class="n">MapPointåœ¨å½“å‰å¸§ä¸­çš„äºŒç»´ä½ç½®</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="o">+</span> <span class="nl">InfoMatrix</span><span class="p">:</span> <span class="n">invSigma2</span><span class="p">(</span><span class="err">ä¸ç‰¹å¾ç‚¹æ‰€åœ¨çš„å°ºåº¦æœ‰å…³</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>å‡½æ•°æ‰§è¡Œæµç¨‹</strong>
<ul>
<li><strong>æ­¥éª¤ä¸€ï¼šæ„é€  g2o ä¼˜åŒ–å™¨</strong>ã€‚</li>
<li><strong>æ­¥éª¤äºŒï¼šå‘ä¼˜åŒ–å™¨ä¸­æ·»åŠ é¡¶ç‚¹ VertexSE3Expmap - å…³é”®å¸§çš„ä½å§¿ã€‚</strong> éå†ç³»ç»Ÿå…³é”®å¸§åˆ—è¡¨ä¸­çš„<strong>æ‰€æœ‰å…³é”®å¸§</strong>ï¼Œä¾æ¬¡æ·»åŠ é¡¶ç‚¹ã€‚
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span> <span class="o">*</span> <span class="n">vSE3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSE3Expmap</span><span class="p">();</span>
<span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toSE3Quat</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">GetPose</span><span class="p">()));</span>
<span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">);</span>
<span class="n">vSE3</span><span class="o">-&gt;</span><span class="n">setFixed</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// å›ºå®šç¬¬ä¸€å¸§çš„ä½å§¿ï¼Œå…¶å®ƒå¸§å¯ä¿®æ­£ä½å§¿
</span><span class="c1"></span><span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span><span class="p">(</span><span class="n">vSE3</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>æ­¥éª¤ä¸‰ï¼šå‘ä¼˜åŒ–å™¨ä¸­æ·»åŠ é¡¶ç‚¹ VertexSBAPointXYZ - åœ°å›¾ç‚¹åæ ‡</strong>ã€‚éå†æ‰€æœ‰å…³é”®å¸§è§‚å¯Ÿåˆ°çš„åœ°å›¾ç‚¹ï¼Œä¾æ¬¡æ·»åŠ ä¸ºé¡¶ç‚¹
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="o">*</span> <span class="n">vPoint</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="p">();</span>
<span class="n">vPoint</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">Converter</span><span class="o">::</span><span class="n">toVector3d</span><span class="p">(</span><span class="n">pMP</span><span class="o">-&gt;</span><span class="n">GetWorldPos</span><span class="p">()));</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">pMP</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="o">+</span><span class="n">maxKFid</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="n">vPoint</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
<span class="n">vPoint</span><span class="o">-&gt;</span><span class="n">setMarginalized</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span><span class="p">(</span><span class="n">vPoint</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>æ­¥éª¤å››ï¼šå‘ä¼˜åŒ–å™¨ä¸­æ·»åŠ è¾¹ EdgeSE3ProjectXYZ - é‡æŠ•å½±è¯¯å·®</strong>ã€‚
<ul>
<li>æ­¥éª¤ 1ï¼šå®ä¾‹åŒ–ä¸€æ¡è¾¹
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSE3ProjectXYZ</span><span class="o">*</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSE3ProjectXYZ</span><span class="p">();</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>æ­¥éª¤ 2ï¼šæ·»åŠ é¡¶ç‚¹
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">e</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">id</span><span class="p">)));</span>
<span class="n">e</span><span class="o">-&gt;</span><span class="n">setVertex</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">g2o</span><span class="o">::</span><span class="n">OptimizableGraph</span><span class="o">::</span><span class="n">Vertex</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">optimizer</span><span class="p">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mnId</span><span class="p">)));</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>æ­¥éª¤ 3ï¼šæ·»åŠ æµ‹é‡å€¼
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">obs</span><span class="p">;</span>
<span class="n">obs</span> <span class="o">&lt;&lt;</span> <span class="n">kpUn</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">kpUn</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
<span class="n">e</span><span class="o">-&gt;</span><span class="n">setMeasurement</span><span class="p">(</span><span class="n">obs</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>æ­¥éª¤ 4ï¼šè®¾ç½®ä¿¡æ¯çŸ©é˜µ
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">const</span> <span class="kt">float</span> <span class="o">&amp;</span><span class="n">invSigma2</span> <span class="o">=</span> <span class="n">pKF</span><span class="o">-&gt;</span><span class="n">mvInvLevelSigma2</span><span class="p">[</span><span class="n">kpUn</span><span class="p">.</span><span class="n">octave</span><span class="p">];</span>
<span class="n">e</span><span class="o">-&gt;</span><span class="n">setInformation</span><span class="p">(</span><span class="n">Eigen</span><span class="o">::</span><span class="n">Matrix2d</span><span class="o">::</span><span class="n">Identity</span><span class="p">()</span><span class="o">*</span><span class="n">invSigma2</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>æ­¥éª¤ 5ï¼šè®¾ç½®æ ¸å‡½æ•°</li>
<li>æ­¥éª¤ 6ï¼šæ·»åŠ åˆ°ä¼˜åŒ–å™¨ä¸­</li>
</ul>
</li>
<li><strong>æ­¥éª¤äº”ï¼šå¼€å§‹ä¼˜åŒ–ï¼Œè¿­ä»£ 20 æ¬¡</strong>ã€‚</li>
<li><strong>æ­¥éª¤å…­ï¼šæ›´æ–°ä¼˜åŒ–ç»“æœ</strong>ï¼ˆå…³é”®å¸§ä½å§¿ã€åœ°å›¾ç‚¹åæ ‡ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<h3 id="54-é—­ç¯å¤„çš„-sim3-ä¼˜åŒ–-optimizesim3">5.4 é—­ç¯å¤„çš„ Sim3 ä¼˜åŒ– OptimizeSim3()</h3>
<ul>
<li><strong>å‡½æ•°æè¿°</strong>
<ul>
<li>
<blockquote>
<p>åœ¨ç”¨ RANSAC æ±‚è§£è¿‡ Sim3ï¼Œä»¥åŠé€šè¿‡ Sim3 åŒ¹é…æ›´å¤šçš„åœ°å›¾ç‚¹åï¼Œ<strong>å¯¹å½“å‰å…³é”®å¸§ï¼Œé—­ç¯å…³é”®å¸§ï¼Œä»¥åŠåŒ¹é…çš„åœ°å›¾ç‚¹è¿›è¡Œä¼˜åŒ–</strong>ï¼Œè·å¾—æ›´å‡†ç¡®çš„ Sim3 å˜æ¢ï¼Œå†è¿›è¡Œä¸‹ä¸€æ­¥çš„é—­ç¯è°ƒæ•´ï¼›</p>
</blockquote>
</li>
<li>å½“æ£€æµ‹åˆ°é—­ç¯æ—¶ï¼Œ<strong>é—­ç¯è¿æ¥çš„ä¸¤ä¸ªå…³é”®å¸§çš„ä½å§¿éœ€è¦é€šè¿‡ Sim3 ä¼˜åŒ–ï¼ˆä»¥ä½¿å¾—å…¶å°ºåº¦ä¸€è‡´ï¼‰</strong>ï¼Œåœ¨å‡½æ•° <code>Optimizer::OptimizeSim3()</code> ä¸­å®ç°ï¼Œä¼˜åŒ–æ±‚è§£<strong>ä¸¤å¸§ä¹‹é—´çš„ç›¸ä¼¼å˜æ¢çŸ©é˜µ</strong>ï¼Œä½¿å¾—äºŒç»´å¯¹åº”ç‚¹çš„<strong>æŠ•å½±è¯¯å·®æœ€å°</strong>ï¼›</li>
<li>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒPos6 å’Œ Pos2 ä¸ºä¸€ä¸ªå¯èƒ½çš„é—­ç¯ï¼Œåˆ™é€šè¿‡ $(u_{4,2},v_{4,2})$ å’Œ $(u_{4,6},v_{4,6})$ ä¹‹é—´çš„æŠ•å½±è¯¯å·®æ¥ä¼˜åŒ– $S_{6,2}$ã€‚</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<ul>
<li><strong>é¡¶ç‚¹ä¸è¾¹</strong>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="mf">1.</span> <span class="nl">Vertex</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSim3Expmap</span><span class="p">()</span><span class="err">ï¼Œä¸¤ä¸ªå…³é”®å¸§çš„ä½å§¿</span>
    <span class="o">-</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSBAPointXYZ</span><span class="p">()</span><span class="err">ï¼Œä¸¤ä¸ªå…³é”®å¸§å…±æœ‰çš„</span> <span class="n">MapPoints</span>
<span class="mf">2.</span> <span class="nl">Edge</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3ProjectXYZ</span><span class="p">()</span><span class="err">ï¼Œ</span><span class="n">BaseBinaryEdge</span><span class="err">ï¼ŒæŠ•å½±åˆ°å½“å‰å¸§</span>
         <span class="o">+</span> <span class="n">Vertex</span><span class="err">ï¼šå…³é”®å¸§çš„</span><span class="n">Sim3</span><span class="err">ï¼Œ</span><span class="n">MapPointçš„Pw</span>
         <span class="o">+</span> <span class="n">measurement</span><span class="err">ï¼š</span><span class="n">MapPointåœ¨å…³é”®å¸§ä¸­çš„äºŒç»´ä½ç½®</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
         <span class="o">+</span> <span class="nl">InfoMatrix</span><span class="p">:</span> <span class="n">invSigma2</span><span class="p">(</span><span class="err">ä¸ç‰¹å¾ç‚¹æ‰€åœ¨çš„å°ºåº¦æœ‰å…³</span><span class="p">)</span>
    <span class="o">-</span> <span class="n">g2o</span><span class="o">::</span><span class="n">EdgeInverseSim3ProjectXYZ</span><span class="p">()</span><span class="err">ï¼Œ</span><span class="n">BaseBinaryEdge</span><span class="err">ï¼ŒæŠ•å½±åˆ°é—­ç¯å¸§</span>
         <span class="o">+</span> <span class="n">Vertex</span><span class="err">ï¼šå…³é”®å¸§çš„</span><span class="n">Sim3</span><span class="err">ï¼Œ</span><span class="n">MapPointçš„Pw</span>
         <span class="o">+</span> <span class="n">measurement</span><span class="err">ï¼š</span><span class="n">MapPointåœ¨å…³é”®å¸§ä¸­çš„äºŒç»´ä½ç½®</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
         <span class="o">+</span> <span class="nl">InfoMatrix</span><span class="p">:</span> <span class="n">invSigma2</span><span class="p">(</span><span class="err">ä¸ç‰¹å¾ç‚¹æ‰€åœ¨çš„å°ºåº¦æœ‰å…³</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>å‡½æ•°æ‰§è¡Œæµç¨‹</strong>
<ul>
<li><strong>æ­¥éª¤ä¸€ï¼š</strong> åˆå§‹åŒ– g2o ä¼˜åŒ–å™¨ï¼›</li>
<li><strong>æ­¥éª¤äºŒï¼š æ·»åŠ é¡¶ç‚¹ VertexSim3Expmap - sim3 ä½å§¿</strong>ï¼Œé¡¶ç‚¹çš„å€¼ä¸ºä¸¤ä¸ªå…³é”®å¸§ä¹‹é—´çš„ sim3 å˜æ¢ï¼›
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">g2o</span><span class="o">::</span><span class="n">VertexSim3Expmap</span> <span class="o">*</span> <span class="n">vSim3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSim3Expmap</span><span class="p">();</span>    
<span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_fix_scale</span><span class="o">=</span><span class="n">bFixScale</span><span class="p">;</span>
<span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">setEstimate</span><span class="p">(</span><span class="n">g2oS12</span><span class="p">);</span>     <span class="c1">// ä¸¤ä¸ªå…³é”®å¸§é—´çš„Sim3å˜æ¢
</span><span class="c1"></span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">setId</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">setFixed</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span><span class="c1">// ä¼˜åŒ–Sim3é¡¶ç‚¹
</span><span class="c1"></span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_principle_point1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">K1</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span> <span class="c1">// å…‰å¿ƒæ¨ªåæ ‡cx
</span><span class="c1"></span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_principle_point1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">K1</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span> <span class="c1">// å…‰å¿ƒçºµåæ ‡cy
</span><span class="c1"></span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_focal_length1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">K1</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// ç„¦è· fx
</span><span class="c1"></span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_focal_length1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">K1</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// ç„¦è· fy
</span><span class="c1"></span><span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_principle_point2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">K2</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_principle_point2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">K2</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
<span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_focal_length2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">K2</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="n">vSim3</span><span class="o">-&gt;</span><span class="n">_focal_length2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">K2</span><span class="p">.</span><span class="n">at</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="n">optimizer</span><span class="p">.</span><span class="n">addVertex</span><span class="p">(</span><span class="n">vSim3</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li><strong>æ­¥éª¤ä¸‰ï¼š æ·»åŠ é¡¶ç‚¹ VertexSBAPointXYZ - ä¸¤å¸§çš„å…±è§†åœ°å›¾ç‚¹</strong>ï¼Œé¡¶ç‚¹çš„å€¼ä¸ºåœ°å›¾ç‚¹çš„ç›¸æœºåæ ‡ï¼›</li>
<li><strong>æ­¥éª¤å››ï¼šæ·»åŠ è¾¹ - é¡¶ç‚¹æŠ•å½±åˆ°å½“å‰å¸§çš„é‡æŠ•å½±è¯¯å·® EdgeSim3ProjectXYZ å’ŒæŠ•å½±åˆ°é—­ç¯å¸§çš„é‡æŠ•å½±è¯¯å·® EdgeInverseSim3ProjectXYZ</strong>ï¼›</li>
<li><strong>æ­¥éª¤äº”ï¼š</strong> å¼€å§‹ä¼˜åŒ–ï¼Œè¿­ä»£ 5 æ¬¡ï¼›</li>
<li><strong>æ­¥éª¤å…­ï¼š</strong> å¡æ–¹æ£€éªŒå‰”é™¤è¯¯å·®è¾ƒå¤§çš„è¾¹ï¼›</li>
<li><strong>æ­¥éª¤ä¸ƒï¼š</strong> å†æ¬¡ä¼˜åŒ–å‰©ä½™çš„è¾¹ï¼Œè¿­ä»£ 5 æˆ–è€… 10 æ¬¡ï¼›</li>
<li><strong>æ­¥éª¤å…«ï¼š</strong> ä¼˜åŒ–ç»“æŸï¼Œè¿”å›ä¸¤å¸§ä¹‹é—´çš„ sim3 å˜æ¢ã€‚</li>
</ul>
</li>
</ul>
<h3 id="55-é—­ç¯åçš„-sim3-ä½å§¿ä¼˜åŒ–-optimizeessentialgraph">5.5 é—­ç¯åçš„ Sim3 ä½å§¿ä¼˜åŒ– OptimizeEssentialGraph()</h3>
<ul>
<li>
<p><strong>å‡½æ•°æè¿°</strong></p>
<ul>
<li>å•ç›® SLAM ä¸€èˆ¬éƒ½ä¼šå‘ç”Ÿ<strong>å°ºåº¦ï¼ˆscaleï¼‰æ¼‚ç§»</strong>ï¼Œå› æ­¤ Sim3 ä¸Šçš„ä¼˜åŒ–æ˜¯å¿…è¦çš„ï¼Œç›¸å¯¹äºSE3ï¼Œ<strong>Sim3 çš„è‡ªç”±åº¦è¦å¤šä¸€ä¸ªï¼Œè€Œä¸”ä¼˜åŒ–çš„ç›®æ ‡æ˜¯çŸ«æ­£å°ºåº¦å› å­ï¼Œå› æ­¤ä¼˜åŒ–å¹¶æ²¡æœ‰åŠ å…¥æ›´å¤šçš„å˜é‡ï¼ˆå¦‚ä¸‰ç»´ç‚¹ï¼‰</strong>ï¼›</li>
<li>åœ¨<strong>æ£€æµ‹åˆ°é—­ç¯æ—¶åœ¨ sim3 ä¸Šå¯¹æ‰€æœ‰çš„ä½å§¿è¿›è¡Œä¸€æ¬¡ä¼˜åŒ–</strong>ï¼Œåœ¨å‡½æ•° <code>Optimizer::OptimizeEssentialGraph()</code> ä¸­æ‰§è¡Œï¼ŒEssentialGraph åŒ…æ‹¬<strong>æ‰€æœ‰çš„å…³é”®å¸§é¡¶ç‚¹</strong>ï¼Œä½†æ˜¯ä¼˜åŒ–è¾¹å¤§å¤§å‡å°‘ï¼ŒåŒ…æ‹¬ spanning treeï¼ˆç”Ÿæˆæ ‘ï¼‰ï¼Œå…±è§†æƒé‡Î¸&gt;100 çš„è¾¹ï¼Œä»¥åŠé—­ç¯è¿æ¥è¾¹ã€‚ç”¨äº<strong>é—­ç¯æ£€æµ‹ Sim3 è°ƒæ•´åä¼˜åŒ–</strong>ã€‚</li>
<li>å®šä¹‰ <strong>sim3 ä¸Šçš„æ®‹å·®</strong>ä¸ºï¼š
$$
e_{i,j}=log_{Sim3}(S_{ij}S_{jw}S_{iw}^{-1})
$$</li>
<li>å…¶ä¸­ $S_{iw}$ çš„åˆå€¼æ˜¯å°ºåº¦ä¸º 1 çš„ pos i ç›¸å¯¹äºä¸–ç•Œåæ ‡ç³»çš„å˜æ¢çŸ©é˜µï¼Œ$S_{jw}$ åŒç†ï¼›</li>
<li>$S_{ij}$ è¡¨ç¤º pos i å’Œ pos j ä¹‹é—´çš„ç›¸å¯¹ä½å§¿çŸ©é˜µï¼ˆsim3 ä¼˜åŒ–ä¹‹å‰ï¼‰ï¼Œè¡¨ç¤º $S_{iw}$ å’Œ $S_{jw}$ ä¹‹é—´çš„æµ‹é‡ï¼›</li>
<li>æ­¤å¤„ç›¸å½“äº<strong>è®¤ä¸ºå±€éƒ¨çš„ç›¸å¯¹ä½å§¿æ˜¯å‡†ç¡®çš„ï¼Œè€Œå…¨å±€ä½å§¿æœ‰ç´¯è®¡è¯¯å·®</strong>ï¼Œæ˜¯ä¸å‡†ç¡®çš„</li>
</ul>
<!-- raw HTML omitted -->
</li>
<li>
<p><strong>é¡¶ç‚¹ä¸è¾¹</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="mf">1.</span> <span class="nl">Vertex</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">g2o</span><span class="o">::</span><span class="n">VertexSim3Expmap</span><span class="err">ï¼Œ</span><span class="n">Essential</span> <span class="n">graphä¸­å…³é”®å¸§çš„ä½å§¿</span>
<span class="mf">2.</span> <span class="nl">Edge</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">g2o</span><span class="o">::</span><span class="n">EdgeSim3</span><span class="p">()</span><span class="err">ï¼Œ</span><span class="n">BaseBinaryEdge</span>
        <span class="o">+</span> <span class="n">Vertex</span><span class="err">ï¼šå…³é”®å¸§çš„</span><span class="n">Tcw</span><span class="err">ï¼Œ</span><span class="n">MapPointçš„Pw</span>
        <span class="o">+</span> <span class="n">measurement</span><span class="err">ï¼šç»è¿‡</span><span class="n">CorrectLoopå‡½æ•°æ­¥éª¤2</span><span class="err">ï¼Œ</span><span class="n">Sim3ä¼ æ’­æ ¡æ­£åçš„ä½å§¿</span>
        <span class="o">+</span> <span class="nl">InfoMatrix</span><span class="p">:</span> <span class="err">å•ä½çŸ©é˜µ</span>   
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong>å‡½æ•°æ‰§è¡Œæµç¨‹</strong></p>
<ul>
<li><strong>æ­¥éª¤ä¸€ï¼š</strong> åˆå§‹åŒ– g2o ä¼˜åŒ–å™¨ï¼›</li>
<li><strong>æ­¥éª¤äºŒï¼š</strong> æ·»åŠ é¡¶ç‚¹ VertexSim3Expmap - åœ°å›¾ä¸­æ‰€æœ‰çš„å…³é”®å¸§ï¼›</li>
<li><strong>æ­¥éª¤ä¸‰ï¼š</strong> æ·»åŠ è¾¹
<ul>
<li>é—­ç¯æ—¶å› ä¸º MapPoints è°ƒæ•´è€Œå‡ºç°çš„æ–°å…³é”®å¸§ä¹‹é—´çš„ sim3 å˜æ¢è¯¯å·®</li>
<li>å½“å‰å¸§ä¸é—­ç¯åŒ¹é…æˆåŠŸçš„å¸§ä¹‹é—´çš„è¯¯å·®</li>
</ul>
</li>
<li><strong>æ­¥éª¤å››ï¼š</strong> å¼€å§‹ä¼˜åŒ–ï¼Œè¿­ä»£ 20 æ¬¡ï¼›</li>
<li><strong>æ­¥éª¤äº”ï¼š</strong> ä¼˜åŒ–ç»“æŸæ›´æ–°ä½å§¿ Sim3:[sR t;0 1] -&gt; SE3:[R t/s;0 1]ï¼›</li>
<li><strong>æ­¥éª¤å…­ï¼š</strong> MapPoints æ ¹æ®å‚è€ƒå¸§ä¼˜åŒ–å‰åçš„ç›¸å¯¹å…³ç³»è°ƒæ•´è‡ªå·±çš„ä½ç½®ï¼ˆåœ°å›¾ç‚¹åæ ‡ä¸æ˜¯ç›´æ¥ä»ä¼˜åŒ–å™¨ä¸­æ›´æ–°çš„ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<hr>
<h2 id="r-å‚è€ƒèµ„æ–™">R. å‚è€ƒèµ„æ–™</h2>
<ul>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzIxOTczOTM4NA==&amp;mid=2247486858&amp;idx=1&amp;sn=ce458d5eb6b1ad11b065d71899e31a04&amp;chksm=97d7e81da0a0610b1e3e12415b6de1501329920c3074ab5b48e759edbb33d264a73f1a9f9faf&amp;scene=21#wechat_redirect">ä»é›¶å¼€å§‹ä¸€èµ·å­¦ä¹ SLAM | ç†è§£å›¾ä¼˜åŒ–ï¼Œä¸€æ­¥æ­¥å¸¦ä½ çœ‹æ‡‚g2oä»£ç </a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzIxOTczOTM4NA==&amp;mid=2247486992&amp;idx=1&amp;sn=ecb7c3ef9bd968e51914c2f5b767428d&amp;chksm=97d7eb87a0a062912a9db9fb16a08129f373791fd3918952342d5db46c0bc4880326a7933671&amp;scene=21#wechat_redirect">ä»é›¶å¼€å§‹ä¸€èµ·å­¦ä¹ SLAM | æŒæ¡g2oé¡¶ç‚¹ç¼–ç¨‹å¥—è·¯</a></li>
<li><a href="https://www.cnblogs.com/CV-life/archive/2019/03/13/10525579.html">ä»é›¶å¼€å§‹ä¸€èµ·å­¦ä¹ SLAM | æŒæ¡g2oè¾¹çš„ä»£ç å¥—è·¯</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/37843131">g2oï¼šéçº¿æ€§ä¼˜åŒ–ä¸å›¾è®ºçš„ç»“åˆ</a></li>
<li><a href="https://www.cnblogs.com/gaoxiang12/p/5244828.html">æ·±å…¥ç†è§£å›¾ä¼˜åŒ–ä¸g2oï¼šå›¾ä¼˜åŒ–ç¯‡</a></li>
</ul>
<hr>
<h2 id="todo">TODO</h2>
<ul>
<li>5.4ï¼Œ5.5 è¿™ä¸¤ä¸ªé—­ç¯æ—¶çš„ä¼˜åŒ–å‡½æ•°æ²¡å¤ªç†è§£ï¼Œåé¢ä¸“é—¨åšä¸€ä¸ªå…³äºé—­ç¯çš„æ€»ç»“æŠŠè¿™ä¸¤ä¸ªå‡½æ•°å¸¦ä¸Šã€‚</li>
</ul>
<hr>
<blockquote>
<p>2019.07.05     <br>
<a href="mailto:wuyanminmax@gmail.com">wuyanminmax@gmail.com</a></p>
</blockquote>

    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/2019-07-12-nonparametric-statistics-and-clustering/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default"> ğŸ“œ è®ºæ–‡é˜…è¯» | åœ¨éå‚æ•°å’Œèšç±»çš„ SLAM ä¸­ä½¿ç”¨ç±»åˆ«ç‰©ä½“è¿›è¡Œå®šä½</span>
            <span class="prev-text nav-mobile">ä¸Šä¸€ç¯‡</span>
          </a>
        <a class="next" href="/2019-07-03-orb-slam2-optimization1/">
            <span class="next-text nav-default"> ğŸ˜€ ORB-SLAM2 ä»£ç è§£è¯»ï¼ˆä¸‰ï¼‰ï¼šä¼˜åŒ– 1ï¼ˆæ¦‚è¿°ï¼‰</span>
            <span class="next-text nav-mobile">ä¸‹ä¸€ç¯‡</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="wuyanminmax@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/wuxiaolang" class="iconfont icon-github" title="github"></a>
      <a href="https://www.zhihu.com/people/wuyanmin2018" class="iconfont icon-zhihu" title="zhihu"></a>
  <a href="https://wym.netlify.com/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  
  

  
  <div class="busuanzi-footer">
    
      
    
  </div>

  <span class="copyright-year">
    &copy; 
    2019 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">wu</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      TeX: {equationNumbers: {autoNumber: "AMS"}},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-160646347-2', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?352520a6e7c1df580f6de1f879049608";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>

<script id="baidu_push">
  (function(){
    if (window.location.hostname === 'localhost') return;
    var bp = document.createElement('script'); bp.async = true;
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
  })();
</script>




</body>
</html>
